<!DOCTYPE html>
<html lang="cs" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VERONA — Premium Trip Architect</title>
    <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,300;12..96,400;12..96,500;12..96,600;12..96,700;12..96,800&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <style>
        :root {
            --fh: 'Bricolage Grotesque', sans-serif;
            --fm: 'Space Mono', monospace;
            --a1: #6366f1;
            --a2: #8b5cf6;
            --a3: #06b6d4;
            --a4: #10b981;
            --aglow: rgba(99,102,241,.35);
            --gb:  rgba(255,255,255,.055);
            --gb2: rgba(255,255,255,.085);
            --gbd: rgba(255,255,255,.10);
            --gbd2:rgba(255,255,255,.18);
            --t1: rgba(255,255,255,.95);
            --t2: rgba(255,255,255,.55);
            --t3: rgba(255,255,255,.28);
            --bg: #060810;
            --r:  20px;
            --rsm:12px;
            --rlg:28px;
            --ease:cubic-bezier(.16,1,.3,1);
        }
        [data-theme="light"] {
            --gb:  rgba(255,255,255,.55);
            --gb2: rgba(255,255,255,.72);
            --gbd: rgba(0,0,0,.07);
            --gbd2:rgba(0,0,0,.13);
            --t1: rgba(10,10,20,.92);
            --t2: rgba(10,10,20,.52);
            --t3: rgba(10,10,20,.28);
            --bg: #eef0f7;
            --aglow:rgba(99,102,241,.18);
        }

        *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
        html{scroll-behavior:smooth;}
        body{font-family:var(--fh);background:var(--bg);color:var(--t1);min-height:100vh;overflow-x:hidden;transition:background .5s,color .5s;}

        /* Aurora */
        .aurora{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden;}
        .blob{position:absolute;border-radius:50%;filter:blur(120px);opacity:.28;animation:drift 18s ease-in-out infinite alternate;}
        [data-theme="light"] .blob{opacity:.12;}
        .blob:nth-child(1){width:700px;height:700px;background:var(--a1);top:-200px;left:-150px;animation-duration:20s;}
        .blob:nth-child(2){width:600px;height:600px;background:var(--a3);top:30%;right:-200px;animation-duration:24s;animation-delay:-6s;}
        .blob:nth-child(3){width:500px;height:500px;background:var(--a4);bottom:-100px;left:30%;animation-duration:16s;animation-delay:-10s;}
        .blob:nth-child(4){width:400px;height:400px;background:var(--a2);top:60%;left:10%;animation-duration:22s;animation-delay:-3s;}
        @keyframes drift{from{transform:translate(0,0) scale(1)}to{transform:translate(60px,40px) scale(1.08)}}

        body::after{content:'';position:fixed;inset:0;z-index:1;pointer-events:none;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='g'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23g)' opacity='1'/%3E%3C/svg%3E");opacity:.02;}
        body>*:not(.aurora){position:relative;z-index:2;}
        .hidden{display:none!important;}

        @keyframes fadeUp{from{opacity:0;transform:translateY(22px)}to{opacity:1;transform:translateY(0)}}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        @keyframes spin{to{transform:rotate(360deg)}}
        .au{animation:fadeUp .6s var(--ease) both;}
        .d1{animation-delay:.08s}.d2{animation-delay:.16s}.d3{animation-delay:.24s}

        /* NAV */
        .nav{position:sticky;top:0;z-index:900;}
        .nav-in{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:0 28px;height:62px;background:var(--gb);backdrop-filter:blur(28px) saturate(180%);-webkit-backdrop-filter:blur(28px) saturate(180%);border-bottom:1px solid var(--gbd);}
        .logo{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--t1);flex-shrink:0;}
        .logo-gem{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--a1),var(--a3));display:flex;align-items:center;justify-content:center;font-size:16px;box-shadow:0 0 18px var(--aglow);flex-shrink:0;}
        .logo-wm{font-size:1.05rem;font-weight:800;letter-spacing:.06em;text-transform:uppercase;}
        .logo-tag{font-family:var(--fm);font-size:.58rem;color:var(--t2);letter-spacing:.04em;display:block;line-height:1;margin-top:2px;}
        .tabs{display:flex;gap:3px;background:rgba(0,0,0,.18);padding:4px;border-radius:99px;border:1px solid var(--gbd);}
        [data-theme="light"] .tabs{background:rgba(0,0,0,.06);}
        .tab{padding:7px 20px;border-radius:99px;border:none;font-family:var(--fh);font-size:.82rem;font-weight:700;cursor:pointer;color:var(--t2);background:transparent;transition:all .25s var(--ease);white-space:nowrap;}
        .tab:hover:not(.active){color:var(--t1);background:var(--gb);}
        .tab.active{background:linear-gradient(135deg,var(--a1),var(--a2));color:#fff;box-shadow:0 4px 16px rgba(99,102,241,.45);}
        .nav-act{display:flex;align-items:center;gap:8px;flex-shrink:0;}

        /* BUTTONS */
        .btn{display:inline-flex;align-items:center;justify-content:center;gap:7px;padding:9px 18px;border-radius:99px;border:none;font-family:var(--fh);font-size:.82rem;font-weight:700;cursor:pointer;transition:all .2s var(--ease);white-space:nowrap;}
        .btn:hover{transform:translateY(-1px);}
        .btn:active{transform:translateY(0);opacity:.85;}
        .bg{background:var(--gb);backdrop-filter:blur(12px);border:1px solid var(--gbd2);color:var(--t1);}
        .bg:hover{background:var(--gb2);}
        .bp{background:linear-gradient(135deg,var(--a1),var(--a2));color:#fff;border:none;box-shadow:0 4px 20px rgba(99,102,241,.4);}
        .bp:hover{box-shadow:0 6px 28px rgba(99,102,241,.6);}
        .ba{background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff;border:none;box-shadow:0 4px 16px rgba(245,158,11,.35);}
        .bgh{background:transparent;border:1px solid var(--gbd2);color:var(--t2);}
        .bgh:hover{color:var(--t1);background:var(--gb);}
        .bi{width:38px;height:38px;padding:0;border-radius:11px;}
        .bf{width:100%;border-radius:var(--rsm);}
        .blg{padding:14px 28px;font-size:.9rem;border-radius:var(--rsm);}
        .btnx{width:32px;height:32px;border-radius:10px;background:var(--gb);border:1px solid var(--gbd);color:var(--t2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.8rem;transition:all .2s;flex-shrink:0;}
        .btnx:hover{background:var(--gb2);color:var(--t1);}

        /* LAYOUT */
        .wrap{max-width:1260px;margin:0 auto;padding:0 24px;}
        .view{padding:32px 0 60px;}
        .pg{display:grid;grid-template-columns:320px 1fr;gap:22px;align-items:start;}
        .fc{max-width:640px;margin:0 auto;}

        /* GLASS CARD */
        .card{background:var(--gb);backdrop-filter:blur(24px) saturate(180%);-webkit-backdrop-filter:blur(24px) saturate(180%);border:1px solid var(--gbd);border-radius:var(--rlg);padding:26px;transition:border-color .3s,box-shadow .3s;}
        .card:hover{border-color:var(--gbd2);box-shadow:0 8px 40px rgba(0,0,0,.2);}
        .sidebar{position:sticky;top:78px;}

        /* FIELDS */
        .f{width:100%;padding:12px 15px;background:rgba(0,0,0,.2);border:1px solid var(--gbd2);border-radius:var(--rsm);color:var(--t1);font-family:var(--fh);font-size:.88rem;font-weight:500;transition:all .2s;margin-bottom:10px;}
        [data-theme="light"] .f{background:rgba(255,255,255,.5);}
        .f::placeholder{color:var(--t3);}
        .f:focus{outline:none;border-color:var(--a1);background:rgba(99,102,241,.08);box-shadow:0 0 0 3px rgba(99,102,241,.15);}
        textarea.f{resize:vertical;min-height:80px;}
        select.f{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='rgba(255,255,255,.4)' fill='none' stroke-width='1.5'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;padding-right:36px;cursor:pointer;}
        [data-theme="light"] select.f{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='rgba(0,0,0,.4)' fill='none' stroke-width='1.5'/%3E%3C/svg%3E");}

        /* ACCORDION */
        .acc{margin-bottom:6px;border-radius:var(--rsm);overflow:hidden;border:1px solid var(--gbd);}
        .ach{padding:11px 14px;font-size:.78rem;font-weight:700;letter-spacing:.05em;text-transform:uppercase;color:var(--t2);cursor:pointer;display:flex;justify-content:space-between;align-items:center;background:rgba(0,0,0,.15);transition:background .2s,color .2s;user-select:none;}
        [data-theme="light"] .ach{background:rgba(0,0,0,.04);}
        .ach:hover{color:var(--t1);background:var(--gb);}
        .aa{transition:transform .3s;font-size:.65rem;}
        .acc.open .aa{transform:rotate(180deg);}
        .acb{max-height:0;overflow:hidden;transition:max-height .35s var(--ease);background:rgba(0,0,0,.1);}
        [data-theme="light"] .acb{background:rgba(255,255,255,.3);}
        .acc.open .acb{max-height:380px;overflow-y:auto;}
        .aci{padding:8px 10px 10px;display:flex;flex-direction:column;gap:2px;}
        .fr{display:flex;align-items:center;gap:9px;padding:7px 9px;border-radius:8px;cursor:pointer;font-size:.83rem;font-weight:500;color:var(--t2);transition:all .15s;}
        .fr:hover{background:var(--gb);color:var(--t1);}
        .fr input[type="checkbox"]{width:15px;height:15px;accent-color:var(--a1);flex-shrink:0;}

        /* TIMELINE */
        .tl{padding:4px 0;display:flex;flex-direction:column;}
        .tr{display:grid;grid-template-columns:56px 1fr;gap:14px;align-items:start;}
        .tr:not(:last-child){margin-bottom:0;}
        .tr-line{width:2px;height:20px;background:linear-gradient(to bottom,rgba(99,102,241,.4),transparent);margin:0 auto;}
        .t-left{display:flex;flex-direction:column;align-items:center;gap:4px;}
        .td{width:42px;height:42px;border-radius:13px;background:linear-gradient(135deg,var(--a1),var(--a2));display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 0 22px var(--aglow),0 4px 14px rgba(99,102,241,.3);font-size:.7rem;color:rgba(255,255,255,.95);font-family:var(--fm);font-weight:700;letter-spacing:-.01em;line-height:1.2;text-align:center;padding:2px;}
        .tt{font-family:var(--fm);font-size:.63rem;color:var(--a1);letter-spacing:.02em;text-align:center;white-space:nowrap;}
        .tc{background:var(--gb2);border:1px solid var(--gbd2);border-radius:20px;padding:18px 22px 18px 20px;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);transition:all .25s var(--ease);position:relative;overflow:hidden;margin-bottom:0;}
        .tc::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:linear-gradient(to bottom,var(--a1),var(--a2));opacity:.75;}
        .tc:hover{border-color:rgba(99,102,241,.42);box-shadow:0 8px 32px rgba(0,0,0,.22);transform:translateX(3px);}
        .tc h4{font-size:1.05rem;font-weight:800;margin-bottom:7px;letter-spacing:-.02em;color:var(--t1);}
        .tc p{font-size:.87rem;color:var(--t2);line-height:1.7;margin:0;}
        .ait{background:linear-gradient(135deg,rgba(99,102,241,.1),rgba(139,92,246,.07));border:1px solid rgba(99,102,241,.28);border-radius:20px;padding:18px 22px;margin-top:14px;color:#a5b4fc;font-size:.88rem;line-height:1.7;display:flex;gap:12px;align-items:flex-start;}
        .ait-ico{font-size:1.1rem;flex-shrink:0;margin-top:1px;}

        /* DIARY */
        .dg{display:grid;grid-template-columns:repeat(auto-fill,minmax(290px,1fr));gap:16px;}
        .dc{background:var(--gb);backdrop-filter:blur(24px) saturate(180%);-webkit-backdrop-filter:blur(24px) saturate(180%);border:1px solid var(--gbd);border-radius:var(--rlg);padding:22px;cursor:pointer;transition:all .3s var(--ease);position:relative;overflow:hidden;display:flex;flex-direction:column;}
        .dc::before{content:'';position:absolute;inset:0;border-radius:inherit;background:linear-gradient(135deg,rgba(99,102,241,.06),transparent 60%);opacity:0;transition:opacity .3s;}
        .dc:hover{transform:translateY(-5px);border-color:rgba(99,102,241,.35);box-shadow:0 20px 60px rgba(0,0,0,.35);}
        .dc:hover::before{opacity:1;}
        .dc.done{border-left:2px solid var(--a4);}

        .chip{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:99px;font-family:var(--fm);font-size:.65rem;font-weight:700;letter-spacing:.03em;}
        .ci{background:rgba(99,102,241,.18);color:#a5b4fc;border:1px solid rgba(99,102,241,.25);}
        .cm{background:rgba(255,255,255,.07);color:var(--t2);border:1px solid var(--gbd);}

        .star{font-size:1.1rem;color:var(--t3);cursor:pointer;transition:all .15s;display:inline-block;}
        .star.lit{color:#fbbf24;}
        .star:hover{transform:scale(1.35);color:#fbbf24;}

        /* FEED */
        .composer{background:var(--gb2);backdrop-filter:blur(28px) saturate(200%);-webkit-backdrop-filter:blur(28px) saturate(200%);border:1px solid var(--gbd2);border-radius:var(--rlg);padding:24px;margin-bottom:20px;}
        .clabel{font-family:var(--fm);font-size:.65rem;color:var(--a1);letter-spacing:.1em;text-transform:uppercase;margin-bottom:14px;}
        .fp{background:var(--gb);backdrop-filter:blur(20px) saturate(160%);-webkit-backdrop-filter:blur(20px) saturate(160%);border:1px solid var(--gbd);border-radius:var(--rlg);padding:22px;margin-bottom:14px;transition:all .3s var(--ease);animation:fadeUp .5s var(--ease) both;}
        .fp:hover{border-color:var(--gbd2);transform:translateY(-2px);box-shadow:0 12px 40px rgba(0,0,0,.2);}
        .ph{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;}
        .pa{display:flex;align-items:center;gap:11px;}
        .an{font-size:.9rem;font-weight:700;}
        .pd{font-family:var(--fm);font-size:.64rem;color:var(--t2);}
        .pt{font-size:.9rem;line-height:1.7;color:var(--t2);white-space:pre-wrap;margin-bottom:10px;}
        .lt{background:linear-gradient(135deg,rgba(99,102,241,.1),rgba(6,182,212,.07));border:1px dashed rgba(99,102,241,.35);border-radius:var(--r);padding:14px 16px;display:flex;justify-content:space-between;align-items:center;margin-top:12px;}
        .ll{font-family:var(--fm);font-size:.62rem;color:var(--a3);text-transform:uppercase;letter-spacing:.07em;margin-bottom:3px;}
        .ln{font-size:.95rem;font-weight:700;}
        .av{width:38px;height:38px;border-radius:50%;background:linear-gradient(135deg,var(--a1),var(--a3));color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:.88rem;background-size:cover;background-position:center;flex-shrink:0;border:1.5px solid var(--gbd2);}

        /* MODALS */
        .overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);z-index:3000;display:none;justify-content:center;align-items:center;padding:20px;}
        .mb{background:var(--gb2);backdrop-filter:blur(40px) saturate(200%);-webkit-backdrop-filter:blur(40px) saturate(200%);border:1px solid var(--gbd2);border-radius:var(--rlg);padding:36px;width:100%;max-width:580px;max-height:90vh;overflow-y:auto;box-shadow:0 40px 80px rgba(0,0,0,.5),0 0 0 1px rgba(99,102,241,.1);animation:fadeUp .4s var(--ease) both;}
        .mh{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:28px;}
        .mt{font-size:1.6rem;font-weight:800;letter-spacing:-.02em;}
        .pa2{width:86px;height:86px;border-radius:50%;background:linear-gradient(135deg,var(--a1),var(--a3));color:#fff;font-size:2rem;font-weight:900;display:flex;align-items:center;justify-content:center;cursor:pointer;background-size:cover;background-position:center;margin:0 auto 8px;border:2px solid var(--gbd2);box-shadow:0 0 0 4px transparent;transition:box-shadow .2s;}
        .pa2:hover{box-shadow:0 0 0 4px rgba(99,102,241,.4);}

        /* COMMENTS */
        .ci2{display:flex;gap:11px;padding:14px;background:rgba(0,0,0,.12);border-radius:var(--r);margin-bottom:10px;border:1px solid var(--gbd);}
        [data-theme="light"] .ci2{background:rgba(255,255,255,.35);}
        .cm2{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;}
        .cn{font-size:.84rem;font-weight:700;}
        .cd{font-family:var(--fm);font-size:.62rem;color:var(--t2);}
        .ct{font-size:.85rem;line-height:1.6;color:var(--t2);}

        /* LIGHTBOX */
        .lbx{position:fixed;inset:0;background:rgba(0,0,0,.92);backdrop-filter:blur(14px);z-index:5000;display:none;justify-content:center;align-items:center;}
        .lbx img{max-width:90vw;max-height:85vh;border-radius:var(--rlg);object-fit:contain;}
        .lbxx{position:absolute;top:22px;right:28px;color:#fff;font-size:1.2rem;cursor:pointer;width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,.1);display:flex;align-items:center;justify-content:center;transition:background .2s;}
        .lbxx:hover{background:rgba(255,255,255,.2);}

        /* MAP */
        .mw{height:380px;border-radius:var(--rlg);overflow:hidden;border:1px solid var(--gbd);margin-bottom:28px;}

        /* CONTACT */
        .cf{position:fixed;bottom:26px;right:26px;left:auto;z-index:2000;display:flex;flex-direction:column;align-items:flex-end;}
        .cb{width:52px;height:52px;border-radius:15px;background:var(--gb);backdrop-filter:blur(12px);border:1px solid var(--gbd2);color:var(--t1);cursor:pointer;font-size:1.1rem;display:flex;align-items:center;justify-content:center;transition:all .3s var(--ease);}
        .cb:hover{background:var(--gb2);transform:translateY(-2px);}
        .cp{position:absolute;bottom:66px;right:0;width:330px;background:var(--gb2);backdrop-filter:blur(32px) saturate(200%);-webkit-backdrop-filter:blur(32px) saturate(200%);border:1px solid var(--gbd2);border-radius:var(--rlg);overflow:hidden;box-shadow:0 24px 64px rgba(0,0,0,.5),0 0 0 1px rgba(99,102,241,.1);display:none;animation:fadeUp .3s var(--ease) both; transform-origin: bottom right;}
        .cph{padding:16px 18px;background:linear-gradient(135deg,var(--a1),var(--a2));color:#fff;font-weight:800;font-size:.85rem;display:flex;justify-content:space-between;align-items:center;}
        .cpb{padding:18px;display:flex;flex-direction:column;gap:10px;}

        /* SECTIONS */
        .ey{font-family:var(--fm);font-size:.64rem;letter-spacing:.1em;text-transform:uppercase;color:var(--a1);margin-bottom:6px;}
        .st{font-size:1.65rem;font-weight:800;letter-spacing:-.02em;margin-bottom:20px;}
        .hr{height:1px;background:var(--gbd);margin:24px 0;}
        .pr{display:flex;justify-content:space-between;align-items:center;padding:9px 13px;background:rgba(0,0,0,.12);border-radius:var(--rsm);border:1px solid var(--gbd);margin-bottom:12px;}
        [data-theme="light"] .pr{background:rgba(0,0,0,.04);}
        .sr{display:flex;justify-content:space-between;padding:10px 13px;background:rgba(0,0,0,.12);border-radius:var(--rsm);border:1px solid var(--gbd);margin-bottom:12px;}
        [data-theme="light"] .sr{background:rgba(0,0,0,.04);}
        .sl{font-family:var(--fm);font-size:.6rem;color:var(--t2);text-transform:uppercase;letter-spacing:.05em;display:block;margin-bottom:3px;}
        .sv{font-size:.88rem;font-weight:700;}
        .ps{display:flex;gap:7px;flex-wrap:wrap;margin-top:10px;}
        .pt2{width:68px;height:68px;border-radius:10px;object-fit:cover;cursor:pointer;transition:all .2s;border:1px solid var(--gbd);}
        .pt2:hover{transform:scale(1.06);border-color:rgba(99,102,241,.45);}
        .ar{display:flex;gap:7px;align-items:center;margin-top:auto;padding-top:14px;}
        .es{grid-column:1/-1;text-align:center;padding:56px 20px;color:var(--t2);border:1px dashed var(--gbd2);border-radius:var(--rlg);}
        .spin{width:20px;height:20px;border:2px solid var(--gbd2);border-top-color:var(--a1);border-radius:50%;animation:spin .7s linear infinite;display:inline-block;}

        /* MAP OVERRIDES */
        .custom-map-marker{background:var(--a1);width:11px;height:11px;border-radius:50%;border:2px solid #fff;box-shadow:0 0 10px var(--a1);}
        .leaflet-popup-content-wrapper,.leaflet-popup-tip{background:#0d1117;color:#fff;border:1px solid rgba(99,102,241,.35);border-radius:14px;}
        .marker-cluster-small div,.marker-cluster-medium div,.marker-cluster-large div{background:linear-gradient(135deg,var(--a1),var(--a2))!important;color:#fff!important;font-weight:800;border-radius:50%;font-family:var(--fm);font-size:.68rem;}

        /* RESULT */
        .rc{margin-bottom:22px;}
        .rtop{padding:28px 28px 22px;background:linear-gradient(135deg,rgba(99,102,241,.12),rgba(6,182,212,.06));border-radius:var(--rlg) var(--rlg) 0 0;border:1px solid var(--gbd);border-bottom:none;position:relative;overflow:hidden;}
        .rtop::after{content:'';position:absolute;top:-60px;right:-60px;width:220px;height:220px;background:radial-gradient(circle,rgba(99,102,241,.25),transparent 70%);pointer-events:none;}
        .rbody{padding:28px;background:var(--gb);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border:1px solid var(--gbd);border-top:none;border-radius:0 0 var(--rlg) var(--rlg);}

        /* MOBILE */
        @media(max-width:768px){
            body{padding-bottom:100px;}
            .nav-in{padding:0 14px;}
            .nav-in .tabs{display:none;}
            .logo-tag{display:none;}
            .mnav{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);z-index:999;background:rgba(6,8,16,.88);backdrop-filter:blur(28px) saturate(200%);-webkit-backdrop-filter:blur(28px) saturate(200%);border:1px solid var(--gbd2);border-radius:99px;padding:6px;display:flex;gap:4px;box-shadow:0 16px 48px rgba(0,0,0,.6);width:calc(100vw - 40px);max-width:340px;}
            [data-theme="light"] .mnav{background:rgba(230,233,248,.88);}
            .mnav .tab{flex:1;text-align:center;font-size:.78rem;padding:8px 10px;}
            .pg{grid-template-columns:1fr;gap:16px;}
            .sidebar{position:static;}
            .card,.dc{padding:18px;border-radius:var(--r);}
            .mb{padding:22px;}
            .cf{bottom:90px;right:14px;left:auto;}
            .nav-act .btn span{display:none;}
            .nav-act{gap:6px;}
        }
        @media(min-width:769px){.mnav{display:none;}}
        ::-webkit-scrollbar{width:5px;}
        ::-webkit-scrollbar-track{background:transparent;}
        ::-webkit-scrollbar-thumb{background:var(--gbd2);border-radius:99px;}
    </style>
</head>
<body>

<div class="aurora" aria-hidden="true">
    <div class="blob"></div><div class="blob"></div>
    <div class="blob"></div><div class="blob"></div>
</div>

<div id="lightbox" class="lbx" onclick="this.style.display='none'">
    <div class="lbxx">✕</div>
    <img id="lightboxImg" src="" alt="">
</div>

<div id="profileModal" class="overlay" onclick="if(event.target===this)this.style.display='none'">
    <div class="mb">
        <div class="mh"><h2 class="mt">Můj Profil</h2><button class="btnx" onclick="document.getElementById('profileModal').style.display='none'">✕</button></div>
        <div style="text-align:center;margin-bottom:22px;">
            <div class="pa2" id="profAvatar" onclick="zmenitAvatar()">V</div>
            <p style="font-family:var(--fm);font-size:.62rem;color:var(--t2);">Kliknutím upravíte fotografii</p>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
            <input type="text" id="profPrezdivka" class="f" placeholder="Přezdívka" style="margin:0;">
            <input type="number" id="profVek" class="f" placeholder="Věk" style="margin:0;">
        </div>
        <div style="height:8px;"></div>
        <input type="text" id="profTelefon" class="f" placeholder="Telefon (volitelné)">
        <textarea id="profBio" class="f" rows="3" placeholder="Pár slov o sobě…"></textarea>
        <button class="btn bp bf blg" onclick="ulozitProfil()">Uložit profil</button>
    </div>
</div>

<div id="donateModal" class="overlay" onclick="if(event.target===this)this.style.display='none'">
    <div class="mb" style="text-align:center;background:linear-gradient(160deg,var(--gb2),rgba(99,102,241,.05));">
        <button class="btnx" style="position:absolute;top:20px;right:20px;" onclick="document.getElementById('donateModal').style.display='none'">✕</button>
        <h2 style="font-size:1.7rem;color:var(--a1);margin-bottom:10px;margin-top:10px;">Podpořit projekt</h2>
        <p style="color:var(--t2);margin-bottom:28px;line-height:1.7;font-size:.92rem;">VERONU vyvíjíme pro usnadnění vašich cest. Pokud vám aplikace dělá radost, budeme vděční za symbolický příspěvek na provoz serverů.</p>
        <button id="btnKoupit" class="btn bp bf blg" onclick="poslatPrispevek()">Přispět 99 Kč</button>
    </div>
</div>

<div id="manualModal" class="overlay" onclick="if(event.target===this)this.style.display='none'">
    <div class="mb">
        <div class="mh"><h2 class="mt">Vlastní plán</h2><button class="btnx" onclick="document.getElementById('manualModal').style.display='none'">✕</button></div>
        <input type="text" id="manLokace" class="f" placeholder="Název výletu (např. Sněžka)">
        <input type="text" id="manDoporuceni" class="f" placeholder="Poznámka (nepovinné)">
        <select id="manObtiznost" class="f">
            <option value="1">Náročnost: 1 — Lehká</option>
            <option value="2" selected>Náročnost: 2 — Střední</option>
            <option value="3">Náročnost: 3 — Těžká</option>
        </select>
        <p class="ey" style="margin-bottom:8px;">Zastávky trasy</p>
        <div id="manEtapy">
            <div class="man-etapa" style="display:flex;gap:7px;margin-bottom:7px;align-items:center;">
                <input type="time" class="f e-cas" style="width:108px;margin:0;" value="09:00">
                <input type="text" class="f e-misto" placeholder="Místo" style="flex:1;margin:0;">
                <input type="text" class="f e-popis" placeholder="Popis" style="flex:2;margin:0;">
            </div>
        </div>
        <button class="btn bgh bf" onclick="pridatEtapu()" style="margin:10px 0 20px;border-radius:var(--rsm);">+ Přidat zastávku</button>
        <button class="btn bp bf blg" onclick="ulozitVlastni()">Uložit do deníku</button>
    </div>
</div>

<nav class="nav au">
    <div class="nav-in">
        <a href="#" class="logo" onclick="location.reload()">
            <div class="logo-gem" style="font-family:var(--fm);font-size:1.1rem;font-weight:700;">V</div>
            <div><span class="logo-wm">Verona</span><span class="logo-tag">Trip Architect</span></div>
        </a>
        <div class="tabs" id="navTabsContainer" style="display:none;">
            <button class="tab" id="t-komunita" onclick="prepniTab('komunita')">Komunita</button>
            <button class="tab" id="t-planovac" onclick="prepniTab('planovac')">Plánovač</button>
        </div>
        <div class="nav-act">
            <button class="btn bg" onclick="document.getElementById('donateModal').style.display='flex'"><span>Podpořit</span></button>
            <button class="btn bgh" id="btnGoogle" onclick="location.href='/auth/google'">Přihlásit</button>
            <button class="btn bg" id="btnProfil" onclick="document.getElementById('profileModal').style.display='flex'" style="display:none;"><span>Profil</span></button>
            <button class="btn bgh bi" style="font-size: 0.75rem; letter-spacing: 0.05em; width: auto; padding: 0 12px;" onclick="prepniRezim()">Režim</button>
        </div>
    </div>
</nav>

<div class="mnav" id="mobileTabsContainer" style="display:none;">
    <button class="tab" id="mt-komunita" onclick="prepniTab('komunita')">Komunita</button>
    <button class="tab" id="mt-planovac" onclick="prepniTab('planovac')">Plánovač</button>
</div>

<div id="viewLanding" class="wrap view au">
    <div style="text-align:center; padding: 80px 20px; max-width: 860px; margin: 0 auto;">
        <p class="ey" style="margin-bottom: 20px; font-size: 0.8rem; letter-spacing: 0.15em;">Premium Trip Architect</p>
        <h1 style="font-size: 4rem; font-weight: 800; margin-bottom: 28px; letter-spacing: -0.03em; line-height: 1.1;">Inteligentní plánování vašich cest</h1>
        <p style="font-size: 1.15rem; color: var(--t2); margin-bottom: 44px; line-height: 1.7; max-width: 700px; margin-left: auto; margin-right: auto;">Objevujte svět s osobním AI architektem. Generujte itineráře na míru, prozkoumávejte interaktivní mapy a sdílejte své zážitky s komunitou cestovatelů.</p>
        <div style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">
            <button class="btn bp blg" onclick="location.href='/auth/google'">Přihlásit se a začít</button>
        </div>
    </div>
    <div class="dg" style="margin-top: 60px;">
        <div class="card" style="text-align: center;">
            <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, var(--a1), var(--a2)); color: white; display: flex; align-items: center; justify-content: center; font-family: var(--fm); font-weight: 700; margin: 0 auto 20px;">AI</div>
            <h3 style="margin-bottom: 12px; font-weight: 700;">AI Architekt</h3>
            <p style="color: var(--t2); font-size: 0.9rem; line-height: 1.6;">Zadejte destinaci, vyberte své zájmy a nechte umělou inteligenci sestavit detailní plán cesty včetně časového harmonogramu.</p>
        </div>
        <div class="card" style="text-align: center;">
            <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, var(--a3), var(--a1)); color: white; display: flex; align-items: center; justify-content: center; font-family: var(--fm); font-weight: 700; margin: 0 auto 20px;">GPX</div>
            <h3 style="margin-bottom: 12px; font-weight: 700;">Interaktivní Mapy</h3>
            <p style="color: var(--t2); font-size: 0.9rem; line-height: 1.6;">Všechny vaše výlety se automaticky propisují do interaktivní mapy. Sledujte svou stopu a exportujte trasy pro navigaci.</p>
        </div>
        <div class="card" style="text-align: center;">
            <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, var(--a4), var(--a3)); color: white; display: flex; align-items: center; justify-content: center; font-family: var(--fm); font-weight: 700; margin: 0 auto 20px;">COM</div>
            <h3 style="margin-bottom: 12px; font-weight: 700;">Aktivní Komunita</h3>
            <p style="color: var(--t2); font-size: 0.9rem; line-height: 1.6;">Inspirujte se deníky ostatních. Sdílejte fotografie z cest, hodnoťte trasy a objevujte ta nejlepší místa od zkušených cestovatelů.</p>
        </div>
    </div>
</div>

<div id="viewKomunita" class="wrap view hidden">
    <div class="fc">
        <div class="composer">
            <p class="clabel">// Nový příspěvek</p>
            <textarea id="feedText" class="f" rows="4" placeholder="Podělte se o zážitky, tipy nebo fotografie z cest…"></textarea>
            <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;">
                <button class="btn bg" onclick="document.getElementById('feedPhotoUpload').click()" style="font-size:.8rem;">Přidat fotky</button>
                <input type="file" id="feedPhotoUpload" multiple accept="image/*" style="display:none;" onchange="nactiFotkyDoFeedu(this)">
                <select id="feedTripSelect" class="f" style="margin:0;flex:1;min-width:160px;font-size:.8rem;"><option value="">Bez navázaného výletu</option></select>
            </div>
            <div id="feedPhotoPreview" style="display:flex;gap:7px;flex-wrap:wrap;margin-bottom:12px;"></div>
            <button class="btn bp bf" onclick="odeslatDoFeedu()" id="btnOdeslatFeed">Publikovat v komunitě</button>
        </div>
        <div id="feedStream">
            <div style="text-align:center;padding:48px;color:var(--t2);">
                <div class="spin" style="margin:0 auto 12px;"></div>
                <p style="font-family:var(--fm);font-size:.75rem;">Načítání komunitních příspěvků…</p>
            </div>
        </div>
    </div>
</div>

<div id="viewPlanovac" class="wrap view hidden">
    <div class="pg">
        <aside class="sidebar">
            <div class="card au d1">
                <p class="ey">AI Architekt</p>
                <h2 style="font-size:1.3rem;font-weight:800;margin-bottom:18px;letter-spacing:-.02em;">Sestavit výlet</h2>
                <input type="text" id="mistoIn" class="f" placeholder="Destinace (např. Šumava, Vídeň)">
                <input type="text" id="specIn" class="f" placeholder="Specifická přání (volitelné)">

                <div class="acc" id="w-kdo">
                    <div class="ach" onclick="toggleAcc('w-kdo','b-kdo')">S kým cestuji <span class="aa">▾</span></div>
                    <div class="acb" id="b-kdo"><div class="aci">
                        <label class="fr"><input type="checkbox" class="ai-filter" value="Sólový cestovatel"> Solo cestovatel</label>
                        <label class="fr"><input type="checkbox" class="ai-filter" value="Romantický výlet ve dvou"> Romantický výlet</label>
                        <label class="fr"><input type="checkbox" class="ai-filter" value="Vhodné pro kočárky a malé děti"> S malými dětmi</label>
                        <label class="fr"><input type="checkbox" class="ai-filter" value="Pro starší děti a teenagery"> S teenagery</label>
                        <label class="fr"><input type="checkbox" class="ai-filter" value="Parta přátel"> Parta přátel</label>
                        <label class="fr"><input type="checkbox" class="ai-filter" value="Pro seniory"> Senioři</label>
                        <label class="fr"><input type="checkbox" class="ai-filter" value="Bezbariérový přístup"> Bezbariérový přístup</label>
                        <label class="fr"><input type="checkbox" class="ai-filter" value="Cestuji se psem"> Cestování se psem</label>
                    </div></div>
                </div>
                <div class="acc" id="w-sport">
                    <div class="ach" onclick="toggleAcc('w-sport','b-sport')">Aktivita a pohyb <span class="aa">▾</span></div>
                    <div class="acb" id="b-sport"><div class="aci">
                        <label class="fr"><input type="checkbox" class="ai-filter" value="Lehká, odpočinková procházka"> Lehká procházka</label>
                        <label class="fr"><input type="checkbox" class="ai-filter" value="Náročná pěší turistika (převýšení)"> Horská turistika</label>
                        <label class="fr"><input type="checkbox" class="ai-filter" value="MTB Cyklistika (terén)"> MTB Cyklistika</label>
                        <label class="fr"><input type="checkbox" class="ai-filter" value="Silniční cyklistika (hladký asfalt)"> Silniční cyklistika</label>
                        <label class="fr"><input type="checkbox" class="ai-filter" value="In-line brusle"> In-line brusle</label>
                        <label class="fr"><input type="checkbox" class="ai-filter" value="Trailový běh v přírodě"> Trailový běh</label>
                        <label class="fr"><input type="checkbox" class="ai-filter" value="Ferraty nebo horolezectví"> Ferraty</label>
                        <label class="fr"><input type="checkbox" class="ai-filter" value="Vodácký výlet"> Vodáctví</label>
                        <label class="fr"><input type="checkbox" class="ai-filter" value="Zimní běžky"> Běžecké lyžování</label>
                    </div></div>
                </div>
                <div class="acc" id="w-vibe">
                    <div class="ach" onclick="toggleAcc('w-vibe','b-vibe')">Zájmy a preference <span class="aa">▾</span></div>
                    <div class="acb" id="b-vibe"><div class="aci">
                        <label class="fr"><input type="checkbox" class="ai-filter" value="Historie, hrady, zámky"> Historie a památky</label>
                        <label class="fr"><input type="checkbox" class="ai-filter" value="Muzea, galerie"> Muzea a kultura</label>
                        <label class="fr"><input type="checkbox" class="ai-filter" value="Gastronomie"> Gastronomie</label>
                        <label class="fr"><input type="checkbox" class="ai-filter" value="Degustace, vína, pivovary"> Vína a Pivovary</label>
                        <label class="fr"><input type="checkbox" class="ai-filter" value="Koupání"> Koupání</label>
                        <label class="fr"><input type="checkbox" class="ai-filter" value="Fotogenická místa"> Fotogenická místa</label>
                        <label class="fr"><input type="checkbox" class="ai-filter" value="Hluboký les, únik od civilizace"> Únik do přírody</label>
                        <label class="fr"><input type="checkbox" class="ai-filter" value="Epické výhledy"> Panoramatické výhledy</label>
                        <label class="fr"><input type="checkbox" class="ai-filter" value="Wellness"> Wellness</label>
                        <label class="fr"><input type="checkbox" class="ai-filter" value="Adrenalin a zábava"> Adrenalin</label>
                    </div></div>
                </div>

                <button class="btn bp bf blg" id="genBtn" onclick="generovat()" style="margin-top:14px;">Sestavit itinerář AI</button>
                <button class="btn bgh bf" onclick="document.getElementById('manualModal').style.display='flex'" style="margin-top:7px;border-radius:var(--rsm);">Vytvořit vlastní plán</button>
            </div>
        </aside>

        <main>
            <div id="resCard" class="rc" style="display:none;">
                <div class="rtop">
                    <p class="ey" id="resDiffText">AI Koncept</p>
                    <h2 id="resTitle" style="font-size:2rem;font-weight:800;letter-spacing:-.03em;margin-bottom:14px;">Název výletu</h2>
                    <div>
                        <p style="font-family:var(--fm);font-size:.6rem;text-transform:uppercase;letter-spacing:.08em;color:var(--t2);margin-bottom:5px;">Hodnocení</p>
                        <div id="resTopRating"></div>
                    </div>
                </div>
                <div class="rbody">
                    <div id="resBody" class="tl"></div>
                    <div class="hr"></div>
                    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
                        <button class="btn bg" onclick="ulozitNovyAI()" id="btnSaveAI">Uložit do deníku</button>
                        <div style="display:flex;gap:8px;align-items:center;">
                            <input type="date" id="dateIn" class="f" style="width:auto;margin:0;">
                            <button class="btn bgh" onclick="doKalendare()">Přidat do kalendáře</button>
                        </div>
                    </div>
                    <div id="commentsSection" style="display:none;margin-top:28px;">
                        <div class="hr"></div>
                        <p class="ey">Komentáře</p>
                        <div id="commentsList" style="margin-bottom:16px;max-height:380px;overflow-y:auto;"></div>
                        <div style="display:flex;gap:11px;align-items:flex-start;background:rgba(0,0,0,.12);padding:16px;border-radius:var(--r);border:1px solid var(--gbd);">
                            <div class="av" id="myMiniAvatar">V</div>
                            <div style="flex:1;">
                                <textarea id="newCommentText" class="f" rows="2" placeholder="Napište komentář k trase…" style="margin-bottom:8px;"></textarea>
                                <button class="btn bp" style="font-size:.8rem;padding:8px 16px;" onclick="odeslatKomentar()">Odeslat komentář</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="globalMap" class="mw"></div>

            <p class="ey">Deník expedic</p>
            <h2 class="st">Moje výlety</h2>
            <div id="diary" class="dg"></div>
        </main>
    </div>
</div>

<div class="cf">
    <button class="cb" onclick="toggleContact()" style="font-family: var(--fm); font-weight: 700;">?</button>
    <div class="cp" id="contactWin">
        <div class="cph">
            <span>Kontaktovat podporu</span>
            <span style="cursor:pointer;" onclick="document.getElementById('contactWin').style.display='none'">✕</span>
        </div>
        <div class="cpb">
            <p style="font-size:.82rem;color:var(--t2);">Máte nápad na zlepšení nebo jste narazili na chybu?</p>
            <input type="text" id="kontaktPredmet" class="f" placeholder="Předmět zprávy" style="margin:0;">
            <textarea id="kontaktZprava" class="f" rows="4" placeholder="Vaše zpráva…" style="margin:0;"></textarea>
            <button class="btn bp bf" onclick="odeslatKontaktV2()">Odeslat zprávu</button>
        </div>
    </div>
</div>

<script>
let curDraft=null,curOpenTripId=null,prihlaseno=false,mainMap=null,markerCluster=null,mujProfil=null,pripraveneFotky=[];

function toggleContact(){const w=document.getElementById('contactWin');if(w.style.display==='flex'){w.style.display='none';return;}w.style.display='flex';w.style.flexDirection='column';}

async function init(){
    try{
        const data=await(await fetch('/api/auth-status')).json();
        if(data.prihlaseno){
            prihlaseno=true;mujProfil=data.profil;
            document.getElementById('btnGoogle').innerText='Přihlášen';
            document.getElementById('btnGoogle').onclick=e=>e.preventDefault();
            document.getElementById('btnProfil').style.display='inline-flex';
            document.getElementById('navTabsContainer').style.display='flex';
            if(window.innerWidth <= 768) document.getElementById('mobileTabsContainer').style.display='flex';
            
            document.getElementById('profPrezdivka').value=mujProfil.prezdivka||'';
            document.getElementById('profVek').value=mujProfil.vek||'';
            document.getElementById('profTelefon').value=mujProfil.telefon||'';
            document.getElementById('profBio').value=mujProfil.bio||'';
            const ini=(mujProfil.jmeno?mujProfil.jmeno.charAt(0):'U').toUpperCase();
            if(mujProfil.avatar){['profAvatar','myMiniAvatar'].forEach(id=>{document.getElementById(id).style.backgroundImage=`url(${mujProfil.avatar})`;document.getElementById(id).innerText='';});}
            else{document.getElementById('profAvatar').innerText=ini;document.getElementById('myMiniAvatar').innerText=ini;}
            
            prepniTab('planovac');
        } else {
            prepniTab('landing');
        }
    }catch(e){
        prepniTab('landing');
    }
    await nactiDnik();await nactiFeed();
}

function prepniTab(tab){
    ['komunita','planovac', 'landing'].forEach(t=>{
        const btn = document.getElementById(`t-${t}`);
        if(btn) btn.classList.remove('active');
        const m = document.getElementById(`mt-${t}`);
        if(m) m.classList.remove('active');
        
        const view = document.getElementById(t==='komunita'?'viewKomunita':(t==='planovac'?'viewPlanovac':'viewLanding'));
        if(view) view.classList.add('hidden');
    });
    
    if(tab !== 'landing') {
        const activeBtn = document.getElementById(`t-${tab}`);
        if(activeBtn) activeBtn.classList.add('active');
        const activeM = document.getElementById(`mt-${tab}`);
        if(activeM) activeM.classList.add('active');
    }
    
    const activeView = document.getElementById(tab==='komunita'?'viewKomunita':(tab==='planovac'?'viewPlanovac':'viewLanding'));
    if(activeView) activeView.classList.remove('hidden');
    
    if(tab==='planovac'&&mainMap)setTimeout(()=>mainMap.invalidateSize(),200);
}

function toggleAcc(wid,bid){const w=document.getElementById(wid),b=document.getElementById(bid),o=w.classList.toggle('open');b.style.maxHeight=o?'380px':'0';}
function prepniRezim(){document.documentElement.setAttribute('data-theme',document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark');}

function zmenitAvatar(){const i=document.createElement('input');i.type='file';i.accept='image/*';i.onchange=e=>{const r=new FileReader();r.onloadend=()=>{mujProfil.avatar=r.result;document.getElementById('profAvatar').style.backgroundImage=`url(${r.result})`;document.getElementById('profAvatar').innerText='';};r.readAsDataURL(e.target.files[0]);};i.click();}
async function ulozitProfil(){await fetch('/api/ulozit-profil',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prezdivka:document.getElementById('profPrezdivka').value,vek:document.getElementById('profVek').value,telefon:document.getElementById('profTelefon').value,bio:document.getElementById('profBio').value,avatar:mujProfil.avatar||''})});document.getElementById('profileModal').style.display='none';alert('Profil uložen!');location.reload();}
async function poslatPrispevek(){document.getElementById('btnKoupit').innerHTML='<div class="spin" style="margin:0 auto"></div>';try{const d=await(await fetch('/api/vytvorit-platbu',{method:'POST'})).json();if(d.url)window.location.href=d.url;}catch(e){document.getElementById('btnKoupit').innerText='Zkusit znovu';}}

function aktualizovatMapu(v){
    if(!mainMap){mainMap=L.map('globalMap').setView([49.8,15.5],5);L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{maxZoom:18}).addTo(mainMap);markerCluster=L.markerClusterGroup({chunkedLoading:true,spiderfyOnMaxZoom:true});mainMap.addLayer(markerCluster);}
    markerCluster.clearLayers();const pts=[];
    const icon=L.divIcon({className:'custom-map-marker',iconSize:[11,11],iconAnchor:[5,5]});
    v.forEach(x=>{if(x.etapy&&x.etapy[0]?.lat){const m=L.marker([x.etapy[0].lat,x.etapy[0].lng],{icon});m.bindPopup(`<div style="text-align:center;padding:4px;"><h4 style="margin:0 0 8px;">${x.lokace}</h4><button onclick="otevritGoogleMaps('${x.id}')" style="background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;border:none;padding:6px 14px;border-radius:9px;cursor:pointer;font-weight:700;font-size:.78rem;">Navigovat k cíli</button></div>`);markerCluster.addLayer(m);pts.push([x.etapy[0].lat,x.etapy[0].lng]);}});
    if(pts.length)mainMap.fitBounds(L.latLngBounds(pts).pad(0.15));
}

async function nactiDnik(){
    const v=await(await fetch('/api/ulozene-vylety')).json();
    aktualizovatMapu(v);
    const d=document.getElementById('diary'),sel=document.getElementById('feedTripSelect');
    sel.innerHTML='<option value="">Bez navázaného výletu</option>';
    if(!v.length){d.innerHTML=`<div class="es"><p style="font-size:.9rem;">Deník je prázdný. Vygenerujte svůj první výlet v plánovači.</p></div>`;return;}
    d.innerHTML='';
    v.forEach((x,i)=>{
        sel.innerHTML+=`<option value="${x.id}">${x.lokace}</option>`;
        const k=document.createElement('div');k.className=`dc au${x.dokonceno?' done':''}`;k.style.animationDelay=`${i*.05}s`;
        const sh=Array.from({length:5},(_,j)=>`<span class="star${j<(x.hodnoceni||0)?' lit':''}">★</span>`).join('');
        const fh=x.fotky?.length?`<div class="ps">${x.fotky.map(f=>`<img src="${f}" class="pt2" onclick="event.stopPropagation();openGallery('${f}')">`).join('')}</div>`:'';
        const ab=(!x.fotky||x.fotky.length<3)?`<button class="btn bg bi" onclick="event.stopPropagation();upload('${x.id}')" style="border-radius:10px; font-size:0.75rem;">Foto</button>`:'';
        k.innerHTML=`
            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px;">
                <div><h3 style="font-size:1.15rem;font-weight:800;letter-spacing:-.02em;margin-bottom:3px;">${x.lokace}</h3><p style="font-family:var(--fm);font-size:.62rem;color:var(--t2);">${x.datumUlozeni||''}</p></div>
                <button class="btnx" onclick="event.stopPropagation();smazat('${x.id}')">✕</button>
            </div>
            <div class="pr"><span class="chip ${x.verejny?'ci':'cm'}">${x.verejny?'Veřejný':'Soukromý'}</span><button class="btn bgh" style="padding:4px 11px;font-size:.7rem;border-radius:8px;" onclick="event.stopPropagation();prepnoutSoukromi('${x.id}',${!x.verejny})">Změnit</button></div>
            <div class="sr"><div><span class="sl">Hodnocení</span><div>${sh}</div></div><div style="text-align:right;"><span class="sl">Komentáře</span><span class="sv">${x.komentare?.length||0}</span></div></div>
            ${fh}
            <div class="ar">${ab}<button class="btn bg bi" onclick="event.stopPropagation();otevritGoogleMaps('${x.id}')" style="border-radius:10px; font-size:0.75rem;">Mapa</button><button class="btn bg" style="padding:8px 13px;font-size:.75rem;color:#fcd34d;border-color:rgba(245,158,11,.25);" onclick="event.stopPropagation();stahnoutGPX('${x.id}','${x.lokace}')">GPX</button><button class="btn ${x.dokonceno?'bgh':'bp'}" style="flex:1;font-size:.8rem;border-radius:10px;" onclick="event.stopPropagation();prepnoutStav('${x.id}',${!x.dokonceno})">${x.dokonceno?'Zrušit':'Splněno'}</button></div>`;
        k.onclick=e=>{if(e.target.tagName==='BUTTON'||e.target.tagName==='IMG')return;otevritDetailVyletu(x);};
        d.appendChild(k);
    });
}

async function upload(id){const v=await(await fetch('/api/ulozene-vylety')).json();const vy=v.find(x=>x.id===id);if(vy.fotky?.length>=3)return alert('Maximálně 3 fotografie.');const i=document.createElement('input');i.type='file';i.accept='image/*';i.onchange=async e=>{const r=new FileReader();r.onloadend=async()=>{if(!vy.fotky)vy.fotky=[];vy.fotky.push(r.result);await fetch('/api/upravit-vylet',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,fotky:vy.fotky})});nactiDnik();};r.readAsDataURL(e.target.files[0]);};i.click();}
async function prepnoutStav(id,s){await fetch('/api/upravit-vylet',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,dokonceno:s})});nactiDnik();}
async function prepnoutSoukromi(id,s){await fetch('/api/upravit-vylet',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,verejny:s})});nactiDnik();}
async function smazat(id){if(confirm('Opravdu chcete výlet smazat?')){await fetch(`/api/smazat-vylet/${id}`,{method:'DELETE'});nactiDnik();document.getElementById('resCard').style.display='none';}}

function otevritDetailVyletu(v){curOpenTripId=v.id;document.getElementById('resTitle').innerText=v.lokace;document.getElementById('resDiffText').innerText='Uloženo: '+(v.datumUlozeni||'');document.getElementById('btnSaveAI').style.display='none';document.getElementById('resBody').innerHTML=v.popis;vykresliHvezdicky(v.id,v.hodnoceni||0);vykresliKomentare(v.komentare||[]);curDraft=v;document.getElementById('resCard').style.display='block';window.scrollTo({top:document.getElementById('resCard').offsetTop-80,behavior:'smooth'});}
function vykresliHvezdicky(id,h){document.getElementById('resTopRating').innerHTML=Array.from({length:5},(_,i)=>`<span class="star${i<h?' lit':''}" onclick="ohodnotitVylet('${id}',${i+1})">★</span>`).join('');}
async function ohodnotitVylet(id,h){await fetch('/api/upravit-vylet',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,hodnoceni:h})});vykresliHvezdicky(id,h);nactiDnik();}

function vykresliKomentare(k){
    document.getElementById('commentsSection').style.display='block';
    const l=document.getElementById('commentsList');
    if(!k.length){l.innerHTML=`<p style="color:var(--t2);font-size:.85rem;text-align:center;padding:20px;">Zatím žádné komentáře.</p>`;return;}
    l.innerHTML=k.map(c=>{
        const av=c.avatar?`background-image:url(${c.avatar});color:transparent;`:'';
        const io=prihlaseno&&mujProfil&&(c.autorId===mujProfil._id||mujProfil.isAdmin);
        const ak=io?`<div style="display:flex;gap:5px;"><button class="btn bgh bi" style="width:26px;height:26px;border-radius:6px;font-size:.75rem;" onclick="upravitKomentar('${c.id}','${encodeURIComponent(c.text)}')">Upravit</button><button class="btn bgh bi" style="width:26px;height:26px;border-radius:6px;font-size:.75rem;" onclick="smazatKomentar('${c.id}')">Smazat</button></div>`:'';
        return `<div class="ci2"><div class="av" style="${av};width:34px;height:34px;font-size:.78rem;">${c.autor?.charAt(0).toUpperCase()||'U'}</div><div style="flex:1;"><div class="cm2"><div><span class="cn">${c.autor}</span><span class="cd" style="margin-left:8px;">${c.datum}</span></div>${ak}</div><p class="ct">${c.text}</p></div></div>`;
    }).join('');
}

async function odeslatKomentar(){if(!prihlaseno)return alert('Pro komentování se prosím přihlaste.');if(!curOpenTripId)return;const t=document.getElementById('newCommentText').value.trim();if(!t)return;document.getElementById('newCommentText').value='';await fetch('/api/pridat-komentar',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({idVyletu:curOpenTripId,text:t})});const v=await(await fetch('/api/ulozene-vylety')).json();vykresliKomentare(v.find(x=>x.id===curOpenTripId)?.komentare||[]);nactiDnik();}
async function smazatKomentar(cid){if(!confirm('Smazat komentář?'))return;await fetch('/api/smazat-komentar',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tripId:curOpenTripId,commentId:cid})});const v=await(await fetch('/api/ulozene-vylety')).json();vykresliKomentare(v.find(x=>x.id===curOpenTripId)?.komentare||[]);}
async function upravitKomentar(cid,enc){const s=decodeURIComponent(enc),n=prompt('Upravit komentář:',s);if(n&&n.trim()&&n!==s){await fetch('/api/upravit-komentar',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tripId:curOpenTripId,commentId:cid,text:n})});const v=await(await fetch('/api/ulozene-vylety')).json();vykresliKomentare(v.find(x=>x.id===curOpenTripId)?.komentare||[]);}}

function nactiFotkyDoFeedu(i){const p=document.getElementById('feedPhotoPreview');p.innerHTML='';pripraveneFotky=[];Array.from(i.files).slice(0,4).forEach(f=>{const r=new FileReader();r.onloadend=()=>{pripraveneFotky.push(r.result);p.innerHTML+=`<img src="${r.result}" style="width:70px;height:70px;border-radius:10px;object-fit:cover;border:1px solid var(--gbd);">`;};r.readAsDataURL(f);});}
async function odeslatDoFeedu(){if(!prihlaseno)return alert('Pro publikování se prosím přihlaste.');const t=document.getElementById('feedText').value.trim();if(!t&&!pripraveneFotky.length)return alert('Příspěvek nemůže být prázdný.');const sel=document.getElementById('feedTripSelect'),btn=document.getElementById('btnOdeslatFeed');btn.innerHTML='<div class="spin"></div>';await fetch('/api/pridat-do-feedu',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:t,fotky:pripraveneFotky,pripojenyVyletId:sel.value,pripojenyVyletLokace:sel.value?sel.options[sel.selectedIndex].text:null})});document.getElementById('feedText').value='';document.getElementById('feedPhotoPreview').innerHTML='';pripraveneFotky=[];btn.innerText='Publikovat v komunitě';nactiFeed();}

async function nactiFeed(){
    const f=await(await fetch('/api/feed')).json();const c=document.getElementById('feedStream');
    if(!f.length){c.innerHTML=`<div class="es"><p style="font-size:.88rem;">Komunita je zatím prázdná. Buďte první, kdo sdílí svůj výlet!</p></div>`;return;}
    c.innerHTML=f.map((p,i)=>{
        const av=p.autorAvatar?`background-image:url(${p.autorAvatar});color:transparent;`:'';
        const fh=p.fotky?.length?`<div class="ps" style="margin-bottom:10px;">${p.fotky.map(img=>`<img src="${img}" class="pt2" style="width:110px;height:80px;" onclick="openGallery('${img}')">`).join('')}</div>`:'';
        const th=p.pripojenyVyletId?`<div class="lt"><div><p class="ll">Sdílený výlet</p><p class="ln">${p.pripojenyVyletLokace}</p></div><button class="btn bp" style="font-size:.76rem;padding:7px 13px;" onclick="otevritGoogleMaps('${p.pripojenyVyletId}')">Mapa</button></div>`:'';
        const io=prihlaseno&&mujProfil&&(p.autorId===mujProfil._id||mujProfil.isAdmin);
        const ak=io?`<div style="display:flex;gap:5px;"><button class="btn bgh bi" style="width:auto;padding:0 8px;border-radius:8px;font-size:.75rem;" onclick="upravitFeed('${p._id}','${encodeURIComponent(p.text)}')">Upravit</button><button class="btn bgh bi" style="width:auto;padding:0 8px;border-radius:8px;font-size:.75rem;" onclick="smazatFeed('${p._id}')">Smazat</button></div>`:'';
        return `<div class="fp" style="animation-delay:${i*.06}s;"><div class="ph"><div class="pa"><div class="av" style="${av}">${p.autorJmeno?.charAt(0).toUpperCase()||'U'}</div><div><p class="an">${p.autorJmeno}</p><p class="pd">${p.datum}</p></div></div>${ak}</div><p class="pt">${p.text}</p>${fh}${th}</div>`;
    }).join('');
}

async function smazatFeed(id){if(confirm('Opravdu chcete příspěvek smazat?')){await fetch(`/api/smazat-feed/${id}`,{method:'DELETE'});nactiFeed();}}
async function upravitFeed(id,enc){const s=decodeURIComponent(enc),n=prompt('Upravit příspěvek:',s);if(n&&n.trim()&&n!==s){await fetch('/api/upravit-feed',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({postId:id,text:n})});nactiFeed();}}

async function generovat(){
    if(!prihlaseno)return alert('Pro plánování výletů se prosím přihlaste.');
    const misto=document.getElementById('mistoIn').value.trim();if(!misto)return alert('Zadejte prosím destinaci.');
    const filtry=Array.from(document.querySelectorAll('.ai-filter:checked')).map(c=>c.value);
    const btn=document.getElementById('genBtn');btn.innerHTML='<div class="spin"></div> Zpracovávám…';btn.disabled=true;
    try{
        const res=await(await fetch('/api/vylet',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({misto,specifikace:document.getElementById('specIn').value,vybraneFiltry:filtry})})).json();
        if(res.uspech){
            curDraft=res.data;curOpenTripId=null;
            document.getElementById('resTitle').innerText=curDraft.lokace;
            document.getElementById('resDiffText').innerText='AI Koncept — Náročnost '+(curDraft.obtiznost||2);
            document.getElementById('resTopRating').innerHTML='<span style="font-family:var(--fm);font-size:.65rem;color:var(--t2);">Pro hodnocení nejprve uložte</span>';
            document.getElementById('commentsSection').style.display='none';
            document.getElementById('btnSaveAI').style.display='inline-flex';
            let h='<div class="tl">';
            curDraft.etapy.forEach((e,i)=>{
                const isLast=i===curDraft.etapy.length-1;
                h+=`<div class="tr">`;
                h+=`<div class="t-left"><div class="td">${String(i+1).padStart(2,'0')}</div><div class="tt">${e.cas}</div></div>`;
                h+=`<div class="tc"><h4>${e.misto}</h4><p>${e.popis}</p></div>`;
                h+=`</div>`;
                if(!isLast) h+=`<div class="tr-line"></div>`;
            });
            h+='</div>';
            if(curDraft.doporuceni)h+=`<div class="ait"><span class="ait-ico">+</span><span>${curDraft.doporuceni}</span></div>`;
            document.getElementById('resBody').innerHTML=h;
            document.getElementById('resCard').style.display='block';
            window.scrollTo({top:document.getElementById('resCard').offsetTop-80,behavior:'smooth'});
        }else alert('Chyba: '+(res.chyba||'Neznámý problém při komunikaci s AI.'));
    }catch(e){alert('Chyba spojení: '+e.message);}
    btn.innerHTML='Sestavit itinerář AI';btn.disabled=false;
}

async function ulozitNovyAI(){if(!curDraft)return;await fetch('/api/ulozit-vylet',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({lokace:curDraft.lokace,popis:document.getElementById('resBody').innerHTML,obtiznost:curDraft.obtiznost,typ:'ai',etapy:curDraft.etapy})});document.getElementById('resCard').style.display='none';nactiDnik();alert('Itinerář byl úspěšně uložen do deníku.');}

function pridatEtapu(){const d=document.createElement('div');d.className='man-etapa';d.style.cssText='display:flex;gap:7px;margin-bottom:7px;align-items:center;';d.innerHTML=`<input type="time" class="f e-cas" style="width:108px;margin:0;" value="12:00"><input type="text" class="f e-misto" placeholder="Místo" style="flex:1;margin:0;"><input type="text" class="f e-popis" placeholder="Popis" style="flex:2;margin:0;"><button onclick="this.parentElement.remove()" style="background:none;border:none;cursor:pointer;color:var(--t2);font-size:1rem;">✕</button>`;document.getElementById('manEtapy').appendChild(d);}
async function ulozitVlastni(){const l=document.getElementById('manLokace').value.trim();if(!l)return alert('Zadejte název výletu.');const etapyEls=Array.from(document.querySelectorAll('.man-etapa'));let h='<div class="tl">';etapyEls.forEach((e,i)=>{const isLast=i===etapyEls.length-1;h+=`<div class="tr"><div class="t-left"><div class="td">${String(i+1).padStart(2,'0')}</div><div class="tt">${e.querySelector('.e-cas').value}</div></div><div class="tc"><h4>${e.querySelector('.e-misto').value}</h4><p>${e.querySelector('.e-popis').value}</p></div></div>`;if(!isLast)h+=`<div class="tr-line"></div>`;});h+='</div>';await fetch('/api/ulozit-vylet',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({lokace:l,popis:h,obtiznost:parseInt(document.getElementById('manObtiznost').value),typ:'vlastni',etapy:[]})});document.getElementById('manualModal').style.display='none';nactiDnik();}

function otevritGoogleMaps(id){fetch('/api/ulozene-vylety').then(r=>r.json()).then(v=>{const x=v.find(x=>x.id===id);if(!x?.etapy?.[0]?.lat)return alert('U tohoto výletu chybí navigační data.');const o=`${x.etapy[0].lat},${x.etapy[0].lng}`,d=`${x.etapy[x.etapy.length-1].lat},${x.etapy[x.etapy.length-1].lng}`,wp=x.etapy.length>2?'&waypoints='+x.etapy.slice(1,-1).map(e=>`${e.lat},${e.lng}`).join('|'):'';window.open(`http://googleusercontent.com/maps.google.com/?origin=${o}&destination=${d}${wp}&travelmode=walking`,'_blank');});}
function stahnoutGPX(id,l){fetch('/api/ulozene-vylety').then(r=>r.json()).then(v=>{const x=v.find(x=>x.id===id);if(!x?.etapy?.[0]?.lat)return alert('U tohoto výletu chybí GPS data.');let g=`<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="VERONA" xmlns="http://www.topografix.com/GPX/1/1">\n  <rte><n>${l}</n>\n`;x.etapy.forEach(b=>{g+=`    <rtept lat="${b.lat}" lon="${b.lng}"><n>${b.misto}</n></rtept>\n`;});g+=`  </rte>\n</gpx>`;const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([g],{type:'application/gpx+xml'}));a.download=`${l.replace(/\s+/g,'_')}.gpx`;document.body.appendChild(a);a.click();});}
function openGallery(s){document.getElementById('lightboxImg').src=s;document.getElementById('lightbox').style.display='flex';}

async function doKalendare(){
    const d=document.getElementById('dateIn').value;
    if(!d)return alert('Vyberte prosím datum.');
    let ml='';
    if(curDraft?.etapy?.[0]?.lat){
        const o=`${curDraft.etapy[0].lat},${curDraft.etapy[0].lng}`;
        const d2=`${curDraft.etapy[curDraft.etapy.length-1].lat},${curDraft.etapy[curDraft.etapy.length-1].lng}`;
        ml=`http://googleusercontent.com/maps.google.com/?origin=${o}&destination=${d2}&travelmode=walking`;
    }
    const r=await fetch('/api/kalendar',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({lokace:document.getElementById('resTitle').innerText,popis:'Trasa vytvořená v aplikaci VERONA',datum:d,mapaLink:ml})
    });
    const data = await r.json();
    if(data.uspech && data.url) {
        window.open(data.url, '_blank'); 
    } else {
        alert('Chyba: ' + (data.chyba || 'Nepodařilo se otevřít kalendář.'));
    }
}

async function odeslatKontaktV2(){const pe=document.getElementById('kontaktPredmet'),ze=document.getElementById('kontaktZprava');if(!pe.value||!ze.value)return alert('Vyplňte prosím všechna pole.');const btn=event.target,orig=btn.innerText;btn.innerHTML='<div class="spin" style="margin:0 auto"></div>';btn.disabled=true;try{const r=await fetch('https://api.web3forms.com/submit',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({access_key:'c8ed8521-b2ea-4c17-ad1a-2379968a739e',subject:`VERONA: ${pe.value}`,from_name:'Uživatel VERONA',message:ze.value})});const res=await r.json();if(res.success){alert('Vaše zpráva byla úspěšně odeslána. Děkujeme.');document.getElementById('contactWin').style.display='none';pe.value='';ze.value='';}else alert('Došlo k chybě: '+res.message);}catch(e){alert('Chyba při komunikaci se serverem.');}btn.innerText=orig;btn.disabled=false;}

window.onload=init;
</script>
</body>
</html>