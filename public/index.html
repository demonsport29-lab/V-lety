<!DOCTYPE html>
<html lang="cs" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VERONA ‚Äî Premium Trip Architect</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800;900&family=Roboto:wght@500&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <style>
        :root {
            --bg: #f4f7f9; --fg: #0f172a; --muted: #64748b;
            --glass: rgba(255, 255, 255, 0.75); --border: rgba(0, 0, 0, 0.08);
            --primary: #DC2626; --primary-hover: #B91C1C; --primary-soft: #FEF2F2;
            --premium: #F59E0B; --premium-soft: #FFFBEB;
            --shadow-sm: 0 4px 6px -1px rgba(0,0,0,0.05); --shadow: 0 20px 40px -10px rgba(0,0,0,0.08);
            --radius-card: 32px; --radius-btn: 999px;
        }
        [data-theme="dark"] {
            --bg: #0b0f19; --fg: #f8fafc; --muted: #94a3b8;
            --glass: rgba(15, 23, 42, 0.7); --border: rgba(255, 255, 255, 0.1);
            --primary: #EF4444; --primary-soft: rgba(239, 68, 68, 0.1);
            --premium: #FBBF24; --premium-soft: rgba(245, 158, 11, 0.1);
            --shadow: 0 20px 40px -10px rgba(0,0,0,0.4);
        }

        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--fg); margin: 0; padding: 0; transition: 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate { animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .hidden { display: none !important; }

        .nav-wrapper { position: sticky; top: 15px; z-index: 1000; padding: 0 20px; display: flex; justify-content: center; margin-bottom: 30px;}
        .nav-bar { display: flex; justify-content: space-between; align-items: center; background: var(--glass); backdrop-filter: blur(20px); padding: 10px 20px; border-radius: 999px; border: 1px solid var(--border); box-shadow: var(--shadow); width: 100%; max-width: 1400px; gap: 20px;}
        .logo { font-weight: 900; font-size: 1.4rem; color: var(--fg); text-decoration: none; display: flex; align-items: center; gap: 8px;}
        .logo span { color: var(--primary); font-size: 1.8rem; }
        
        .main-tabs { display: flex; gap: 10px; background: var(--border); padding: 5px; border-radius: 999px;}
        .tab-btn { padding: 10px 25px; border-radius: 999px; border: none; font-weight: 800; cursor: pointer; transition: 0.3s; background: transparent; color: var(--muted); font-size: 0.95rem;}
        .tab-btn.active { background: var(--bg); color: var(--fg); box-shadow: var(--shadow-sm); }
        .tab-btn:hover:not(.active) { color: var(--fg); }

        .app-layout { display: grid; grid-template-columns: 360px 1fr; gap: 30px; max-width: 1300px; margin: 0 auto; padding: 0 20px; align-items: start; }
        @media (max-width: 950px) { .app-layout { grid-template-columns: 1fr; } }
        .feed-layout { max-width: 700px; margin: 0 auto; padding: 0 20px; }

        .card { background: var(--glass); backdrop-filter: blur(20px); border: 1px solid var(--border); border-radius: var(--radius-card); padding: 35px; box-shadow: var(--shadow); margin-bottom: 30px;}
        h2 { font-weight: 800; font-size: 2rem; margin-top: 0; margin-bottom: 20px; }

        .feed-composer { background: var(--glass); border: 1px solid var(--border); border-radius: 24px; padding: 25px; margin-bottom: 30px; box-shadow: var(--shadow);}
        .feed-post { background: var(--glass); border: 1px solid var(--border); border-radius: 24px; padding: 25px; margin-bottom: 25px; box-shadow: var(--shadow-sm); transition: 0.3s;}
        .feed-post:hover { border-color: var(--primary-soft); transform: translateY(-3px);}
        .feed-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .feed-text { line-height: 1.6; margin-bottom: 15px; white-space: pre-wrap; font-size: 1.05rem;}
        .feed-linked-trip { background: var(--bg); border: 1px dashed var(--primary); padding: 15px; border-radius: 16px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;}

        .btn { padding: 14px 28px; border-radius: var(--radius-btn); border: none; font-weight: 700; cursor: pointer; transition: 0.3s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.95rem;}
        .btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-sm); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--border); color: var(--fg); }
        .btn-premium { background: linear-gradient(135deg, #F59E0B, #D97706); color: white; border: none;}
        
        input[type="text"], input[type="time"], input[type="number"], select, textarea { width: 100%; padding: 16px 20px; border-radius: 16px; border: 2px solid transparent; background: var(--bg); color: var(--fg); margin-bottom: 15px; box-sizing: border-box; font-size: 1rem; font-family: inherit; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); background: var(--glass); box-shadow: 0 0 0 4px var(--primary-soft); }
        
        .accordion { margin-bottom: 10px; border-radius: 20px; background: var(--bg); overflow: hidden; transition: 0.3s; border: 1px solid transparent; }
        .accordion-header { padding: 16px; font-weight: 700; cursor: pointer; display: flex; justify-content: space-between;}
        .accordion-content { padding: 0 16px; max-height: 0; overflow-y: auto; transition: 0.4s; display: flex; flex-direction: column; gap: 8px;}
        .accordion-content.open { padding: 0 16px 16px 16px; max-height: 450px; }
        .filter-label { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; font-weight: 600; cursor: pointer; padding: 8px; border-radius: 12px; }
        .filter-label:hover { background: var(--glass); }
        .filter-label input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--primary); }
        
        .photo-gallery { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .photo-item { width: 80px; height: 80px; border-radius: 16px; object-fit: cover; cursor: pointer; transition: 0.3s; border: 2px solid transparent;}
        .photo-item:hover { transform: scale(1.05); border-color: var(--primary); box-shadow: var(--shadow); }
        
        .lightbox { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); z-index: 5000; display: none; justify-content: center; align-items: center; flex-direction: column;}
        .lightbox img { max-width: 90%; max-height: 80vh; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .lightbox-close { position: absolute; top: 30px; right: 40px; color: white; font-size: 2rem; cursor: pointer; font-weight: 900;}
        
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); z-index: 3000; display: none; justify-content: center; align-items: center; padding: 20px;}
        .modal-content { background: var(--bg); width: 100%; max-width: 650px; border-radius: 32px; padding: 40px; border: 1px solid var(--border); box-shadow: 0 30px 60px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;}
        
        .profile-avatar-large { width: 100px; height: 100px; border-radius: 50%; background: var(--primary); color: white; display: flex; justify-content: center; align-items: center; font-size: 2.5rem; font-weight: 900; cursor: pointer; background-size: cover; background-position: center; border: 4px solid var(--bg); box-shadow: var(--shadow); margin: 0 auto 20px auto;}
        .comment-avatar { width: 45px; height: 45px; border-radius: 50%; background: var(--primary); color: white; display: flex; justify-content: center; align-items: center; font-weight: 700; background-size: cover; background-position: center; flex-shrink: 0;}
        
        .comment-box { display: flex; gap: 15px; margin-bottom: 20px; background: var(--glass); padding: 15px; border-radius: 20px; border: 1px solid var(--border);}
        .comment-content { flex: 1; }
        .comment-author { font-weight: 800; font-size: 0.95rem; margin-bottom: 3px; display: flex; justify-content: space-between; align-items: center;}
        .comment-date { font-size: 0.75rem; color: var(--muted); font-weight: 500; }
        .comment-text { font-size: 0.95rem; margin: 0; color: var(--fg); line-height: 1.5; }

        .step { display: flex; gap: 30px; border-left: 2px dashed var(--border); padding: 0 0 40px 30px; position: relative; margin-top: 20px; transition: 0.3s;}
        .step:hover { border-left-color: var(--primary); }
        .step::after { content: ""; width: 20px; height: 20px; background: var(--primary); border-radius: 50%; position: absolute; left: -11px; top: 0; border: 6px solid var(--bg); }
        .step-time { font-weight: 900; color: var(--primary); font-size: 1.1rem; min-width: 60px; margin-top: -2px;}
        .step-content { background: var(--bg); padding: 20px 24px; border-radius: 20px; flex: 1; border: 1px solid var(--border); }
        
        .bento-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 30px; }
        .bento-card { background: var(--glass); border: 1px solid var(--border); padding: 30px; border-radius: var(--radius-card); transition: 0.4s; cursor: pointer; position: relative; overflow: hidden; display: flex; flex-direction: column;}
        .bento-card:hover { transform: translateY(-10px); box-shadow: var(--shadow); border-color: var(--primary-soft); }
        .bento-card.done::before { content: ""; position: absolute; left: 0; top: 0; bottom: 0; width: 6px; background: #22c55e; }

        .custom-map-marker { background: var(--primary); width: 14px; height: 14px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 15px var(--primary); }
        .leaflet-popup-content-wrapper, .leaflet-popup-tip { background: #111827; color: #fff; border: 1px solid var(--primary); border-radius: 16px; }
        .marker-cluster-small div, .marker-cluster-medium div, .marker-cluster-large div { background-color: rgba(220, 38, 38, 0.9) !important; color: white !important; font-weight: 800; border-radius: 50%; }
        .admin-badge { background: linear-gradient(135deg, #FFD700, #F59E0B); color: black; font-weight: 900; padding: 2px 8px; border-radius: 8px; font-size: 0.7rem; margin-left: 10px; }
        .star-hover:hover { transform: scale(1.3); color: var(--premium) !important; cursor: pointer;}
        
        /* Akƒçn√≠ tlaƒç√≠tka v koment√°≈ô√≠ch */
        .action-btn { background: none; border: none; cursor: pointer; color: var(--muted); font-size: 0.9rem; transition: 0.2s; padding: 2px; }
        .action-btn:hover { transform: scale(1.2); color: var(--primary); }
        /* ==================================================== */
        /* üì± MOBILN√ç VERZE (Smartphony - iOS i Android)       */
        /* ==================================================== */
        @media (max-width: 768px) {
            /* 1. M√≠sto pro spodn√≠ menu, aby nep≈ôekr√Ωvalo obsah */
            body { padding-bottom: 100px; } 

            /* 2. Zmen≈°en√≠ horn√≠ navigace */
            .nav-bar { flex-wrap: wrap; padding: 12px 15px; border-radius: 20px; gap: 10px; justify-content: center;}
            .logo { font-size: 1.2rem; }
            
            /* 3. Zmen≈°en√≠ tlaƒç√≠tek naho≈ôe, aby se ve≈°la vedle sebe */
            .btn { padding: 10px 16px; font-size: 0.85rem; }
            #btnGoogle, #btnProfil { font-size: 0.8rem; padding: 10px 12px; }

            /* 4. SPODN√ç NAVIGACE (App-like feel pro palec) */
            .main-tabs { 
                position: fixed; 
                bottom: env(safe-area-inset-bottom, 20px); /* Ochrana pro iPhony s ƒç√°rkou dole */
                left: 50%; 
                transform: translateX(-50%); 
                z-index: 9999; 
                box-shadow: 0 -10px 40px rgba(0,0,0,0.15); 
                background: var(--glass);
                backdrop-filter: blur(20px);
                padding: 8px;
                width: 90%;
                max-width: 400px;
                justify-content: space-between;
            }
            [data-theme="dark"] .main-tabs { box-shadow: 0 -10px 40px rgba(0,0,0,0.6); }
            .tab-btn { flex: 1; padding: 12px 10px; font-size: 0.9rem; text-align: center; }

            /* 5. Zmen≈°en√≠ ob≈ô√≠ch pr√°zdn√Ωch okraj≈Ø (Padding) */
            .app-layout { padding: 0 10px; gap: 20px; }
            .feed-layout { padding: 0 10px; }
            .card { padding: 20px; border-radius: 24px; margin-bottom: 20px;}
            .bento-card { padding: 20px; }
            
            /* 6. Modaly (Vyskakovac√≠ okna) - aby nep≈ôet√©kaly z obrazovky */
            .modal-content { padding: 25px 20px; border-radius: 24px; margin: 10px; width: calc(100% - 20px); max-height: 85vh;}
            
            /* 7. Mapa - Zmen≈°en√≠ v√Ω≈°ky, aby nezabrala cel√Ω displej mobilu */
            #globalMap { height: 300px !important; margin-bottom: 25px;}

            /* 8. Komunita Feed - Kompaktnƒõj≈°√≠ zobrazen√≠ */
            .feed-composer { padding: 15px; }
            .feed-post { padding: 15px; }
            .photo-gallery .photo-item { width: 70px; height: 70px; }
        }
    </style>
</head>
<body>

    <div id="lightbox" class="lightbox" onclick="this.style.display='none'">
        <span class="lightbox-close">‚úï</span>
        <img id="lightboxImg" src="">
    </div>

    <div id="profileModal" class="modal" onclick="if(event.target === this) this.style.display='none'">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                <h2 style="font-size: 2.2rem; margin-bottom: 5px;">M≈Øj Profil</h2>
                <button onclick="document.getElementById('profileModal').style.display='none'" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--muted);">‚úï</button>
            </div>
            <div style="text-align: center; margin-bottom: 30px;">
                <div class="profile-avatar-large" id="profAvatar" onclick="zmenitAvatar()" title="Zmƒõnit fotku">V</div>
                <p style="color: var(--muted); font-size: 0.85rem; margin-top: -10px;">Klikni na fotku pro jej√≠ zmƒõnu</p>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <input type="text" id="profPrezdivka" placeholder="P≈ôezd√≠vka (Nickname)">
                <input type="number" id="profVek" placeholder="Vƒõk">
                <input type="text" id="profTelefon" placeholder="Telefon (voliteln√©)" style="grid-column: 1 / -1;">
            </div>
            <textarea id="profBio" rows="3" placeholder="Nƒõco m√°lo o mnƒõ a m√©m stylu cestov√°n√≠..."></textarea>
            <button class="btn btn-primary" style="width: 100%; margin-top: 10px;" onclick="ulozitProfil()">üíæ Ulo≈æit profil</button>
        </div>
    </div>

    <div id="premiumModal" class="modal" onclick="if(event.target === this) this.style.display='none'">
        <div class="modal-content" style="text-align: center; background: linear-gradient(135deg, var(--bg), var(--premium-soft)); border-color: var(--premium);">
            <div style="font-size: 4rem; margin-bottom: 10px;">üëë</div>
            <h2 style="color: var(--premium);">VERONA Premium</h2>
            <p style="font-size: 1.1rem; color: var(--muted); margin-bottom: 30px;">Odemknƒõte pln√Ω potenci√°l sv√Ωch cest.</p>
            <ul style="text-align: left; margin: 0 auto 30px auto; max-width: 300px; font-weight: 600; line-height: 2;">
                <li>‚ú® Neomezen√© AI generov√°n√≠</li>
                <li>üì∏ Neomezen√© nahr√°v√°n√≠ fotek</li>
                <li>üó∫Ô∏è Export tras do GPX</li>
            </ul>
            <button id="btnKoupit" class="btn btn-premium" style="width: 100%; padding: 20px; font-size: 1.2rem;" onclick="koupitPremium()">Po≈ô√≠dit za 99 Kƒç</button>
        </div>
    </div>

    <div id="manualModal" class="modal" onclick="if(event.target === this) this.style.display='none'">
        <div class="modal-content" style="max-width: 700px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                <h2 style="margin: 0;">Vytvo≈ôit vlastn√≠ pl√°n</h2>
                <button onclick="document.getElementById('manualModal').style.display='none'" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--muted);">‚úï</button>
            </div>
            <input type="text" id="manLokace" placeholder="N√°zev v√Ωletu (nap≈ô. Snƒõ≈æka)">
            <input type="text" id="manDoporuceni" placeholder="Pozn√°mka (nepovinn√©)">
            <select id="manObtiznost">
                <option value="1">N√°roƒçnost: 1 (Lehk√° / Proch√°zka)</option>
                <option value="2" selected>N√°roƒçnost: 2 (St≈ôedn√≠ / Klasika)</option>
                <option value="3">N√°roƒçnost: 3 (Tƒõ≈æk√° / Sportovn√≠)</option>
            </select>
            <div id="manEtapy">
                <div class="man-etapa" style="display:flex; gap:10px; margin-bottom:10px;">
                    <input type="time" class="e-cas" style="width:120px;" value="09:00">
                    <input type="text" class="e-misto" placeholder="Bod cesty" style="flex:1;">
                    <input type="text" class="e-popis" placeholder="Co tam uvid√≠me?" style="flex:2;">
                </div>
            </div>
            <button class="btn btn-outline" onclick="pridatEtapu()" style="margin-bottom:30px; padding: 10px 15px;">+ P≈ôidat zast√°vku</button>
            <button class="btn btn-primary" style="width:100%; padding: 20px; font-size: 1.1rem;" onclick="ulozitVlastni()">üíæ Ulo≈æit do den√≠ku</button>
        </div>
    </div>

    <div class="nav-wrapper animate">
        <nav class="nav-bar">
            <a href="#" class="logo" onclick="location.reload()"><span>‚Ä¢</span> VERONA</a>
            
            <div class="main-tabs">
                <button class="tab-btn active" onclick="prepniHlavniTab('komunita')" id="t-komunita">üåç Komunita</button>
                <button class="tab-btn" onclick="prepniHlavniTab('planovac')" id="t-planovac">üó∫Ô∏è M≈Øj Pl√°novaƒç</button>
            </div>

            <div style="display: flex; gap: 10px; align-items: center;">
                <button class="btn btn-outline" id="btnGoogle" onclick="location.href='/auth/google'" style="padding: 10px 16px; border-radius: var(--radius-btn);">P≈ôihl√°sit</button>
                <button class="btn btn-outline" id="btnProfil" onclick="document.getElementById('profileModal').style.display='flex'" style="padding: 10px 16px; border-radius: var(--radius-btn); display: none;">üë§ Profil</button>
                <button class="btn btn-outline" onclick="prepniRezim()" style="padding: 10px; border-radius: 50%; width: 44px; height: 44px;">üåì</button>
            </div>
        </nav>
    </div>

    <div id="viewKomunita" class="feed-layout animate-up">
        <div class="feed-composer">
            <h3 style="margin-top: 0; font-weight: 800; font-size: 1.4rem;">Napsat p≈ô√≠spƒõvek</h3>
            <textarea id="feedText" rows="4" placeholder="Podƒõl se o sv√© z√°≈æitky, tipy nebo aktu√°ln√≠ fotky z cest..." style="border-radius: 16px; padding: 15px; margin-bottom: 10px;"></textarea>
            
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn btn-outline" style="padding: 10px 15px; font-size: 0.85rem;" onclick="document.getElementById('feedPhotoUpload').click()">üì∏ P≈ôidat fotky</button>
                <input type="file" id="feedPhotoUpload" multiple accept="image/*" style="display: none;" onchange="nactiFotkyDoFeedu(this)">
                
                <select id="feedTripSelect" style="margin: 0; padding: 10px 15px; font-size: 0.85rem; width: auto; flex: 1;">
                    <option value="">Nep≈ôipojovat ≈æ√°dn√Ω v√Ωlet</option>
                </select>
            </div>
            <div id="feedPhotoPreview" style="display: flex; gap: 10px; overflow-x: auto; margin-bottom: 15px;"></div>
            
            <button class="btn btn-primary" style="width: 100%;" onclick="odeslatDoFeedu()" id="btnOdeslatFeed">Odeslat do komunity</button>
        </div>

        <div id="feedStream">
            <p style="text-align: center; color: var(--muted); padding: 40px;">Naƒç√≠t√°m komunitu...</p>
        </div>
    </div>

    <div id="viewPlanovac" class="app-layout hidden animate-up">
        <aside class="sidebar">
            <div class="card">
                <h2 style="font-size: 1.6rem;">Architekt trasy</h2>
                <input type="text" id="mistoIn" placeholder="Destinace (nap≈ô. ≈†umava, V√≠de≈à)">
                <input type="text" id="specIn" placeholder="Dodateƒçn√© p≈ô√°n√≠ (voliteln√©)">
                
                <div class="accordion">
                    <div class="accordion-header" onclick="toggleAcc('acc-kdo')">S k√Ωm cestuji? <span>‚ñº</span></div>
                    <div class="accordion-content" id="acc-kdo">
                        <label class="filter-label"><input type="checkbox" class="ai-filter" value="S√≥lov√Ω cestovatel"> üö∂ S√≥lov√Ω cestovatel</label>
                        <label class="filter-label"><input type="checkbox" class="ai-filter" value="Romantick√Ω v√Ωlet ve dvou"> ü•Ç Romantika ve dvou</label>
                        <label class="filter-label"><input type="checkbox" class="ai-filter" value="Vhodn√© pro koƒç√°rky a mal√© dƒõti"> üë∂ S dƒõtmi / Koƒç√°rek</label>
                        <label class="filter-label"><input type="checkbox" class="ai-filter" value="Pro star≈°√≠ dƒõti a teenagery"> üßë‚Äçü§ù‚Äçüßë S teenagery</label>
                        <label class="filter-label"><input type="checkbox" class="ai-filter" value="Parta p≈ô√°tel"> üçª S partou p≈ô√°tel</label>
                        <label class="filter-label"><input type="checkbox" class="ai-filter" value="Pro seniory"> üßì Pro seniory (lehk√©)</label>
                        <label class="filter-label"><input type="checkbox" class="ai-filter" value="Bezbari√©rov√Ω p≈ô√≠stup"> ‚ôø Bezbari√©rov√©</label>
                        <label class="filter-label"><input type="checkbox" class="ai-filter" value="Cestuji se psem"> üêï Se psem</label>
                    </div>
                </div>

                <div class="accordion">
                    <div class="accordion-header" onclick="toggleAcc('acc-sport')">Aktivita a pohyb <span>‚ñº</span></div>
                    <div class="accordion-content" id="acc-sport">
                        <label class="filter-label"><input type="checkbox" class="ai-filter" value="Lehk√°, odpoƒçinkov√° proch√°zka"> üö∂ Lehk√° proch√°zka</label>
                        <label class="filter-label"><input type="checkbox" class="ai-filter" value="N√°roƒçn√° pƒõ≈°√≠ turistika (p≈ôev√Ω≈°en√≠)"> ü•æ N√°roƒçn√° turistika</label>
                        <label class="filter-label"><input type="checkbox" class="ai-filter" value="MTB Cyklistika (ter√©n)"> üöµ MTB Cyklistika</label>
                        <label class="filter-label"><input type="checkbox" class="ai-filter" value="Silniƒçn√≠ cyklistika (hladk√Ω asfalt)"> üö≤ Silniƒçn√≠ kolo</label>
                        <label class="filter-label"><input type="checkbox" class="ai-filter" value="In-line brusle"> üõº In-line brusle</label>
                        <label class="filter-label"><input type="checkbox" class="ai-filter" value="Trailov√Ω bƒõh v p≈ô√≠rodƒõ"> üèÉ Trailov√Ω bƒõh</label>
                        <label class="filter-label"><input type="checkbox" class="ai-filter" value="Ferraty nebo horolezectv√≠"> üßó Ferraty / Lezen√≠</label>
                        <label class="filter-label"><input type="checkbox" class="ai-filter" value="Vod√°ck√Ω v√Ωlet"> üõ∂ Vod√°ctv√≠</label>
                        <label class="filter-label"><input type="checkbox" class="ai-filter" value="Zimn√≠ bƒõ≈æky"> ‚õ∑Ô∏è Zimn√≠ bƒõ≈æky</label>
                    </div>
                </div>

                <div class="accordion">
                    <div class="accordion-header" onclick="toggleAcc('acc-vibe')">Z√°jmy a Vibe <span>‚ñº</span></div>
                    <div class="accordion-content" id="acc-vibe">
                        <label class="filter-label"><input type="checkbox" class="ai-filter" value="Historie, hrady, z√°mky"> üè∞ Historie & Pam√°tky</label>
                        <label class="filter-label"><input type="checkbox" class="ai-filter" value="Muzea, galerie"> üèõÔ∏è Muzea & Kultura</label>
                        <label class="filter-label"><input type="checkbox" class="ai-filter" value="Gastronomie"> üçî Gastronomie</label>
                        <label class="filter-label"><input type="checkbox" class="ai-filter" value="Degustace, v√≠na, pivovary"> üç∑ V√≠na & Pivovary</label>
                        <label class="filter-label"><input type="checkbox" class="ai-filter" value="Koup√°n√≠"> üèä Koup√°n√≠</label>
                        <label class="filter-label"><input type="checkbox" class="ai-filter" value="Fotogenick√° m√≠sta"> üì∏ Fotogenick√° m√≠sta</label>
                        <label class="filter-label"><input type="checkbox" class="ai-filter" value="Hlubok√Ω les, √∫nik od civilizace"> üå≤ √önik od civilizace</label>
                        <label class="filter-label"><input type="checkbox" class="ai-filter" value="Epick√© v√Ωhledy"> ‚õ∞Ô∏è Epick√© v√Ωhledy</label>
                        <label class="filter-label"><input type="checkbox" class="ai-filter" value="Wellness"> üíÜ Wellness & Relax</label>
                        <label class="filter-label"><input type="checkbox" class="ai-filter" value="Adrenalin a z√°bava"> üé¢ Adrenalin & Z√°bava</label>
                    </div>
                </div>

                <button class="btn btn-primary" id="genBtn" onclick="generovat()" style="margin-top: 20px; width: 100%; padding: 18px; font-size: 1.05rem;">‚ú® Sestavit pomoc√≠ AI</button>
                <button class="btn btn-outline" onclick="document.getElementById('manualModal').style.display='flex'" style="margin-top: 15px; width: 100%;">‚úçÔ∏è Vytvo≈ôit vlastn√≠ pl√°n</button>
            </div>
        </aside>

        <main class="content">
            <div class="card" id="resCard" style="display: none; margin-bottom: 40px; position: relative;">
                <div style="display: flex; justify-content: space-between; border-bottom: 2px solid var(--border); padding-bottom: 20px; align-items: flex-start;">
                    <div>
                        <h2 id="resTitle" style="font-size: 2.5rem; margin: 0; letter-spacing: -1px;">N√°zev</h2>
                        <span id="resDiffText" style="font-size: 0.85rem; font-weight: 800; color: var(--muted); text-transform: uppercase;"></span>
                    </div>
                    <div style="text-align: right; background: var(--bg); padding: 15px 20px; border-radius: 20px; border: 1px solid var(--border); min-width: 140px;">
                        <span style="font-size: 0.75rem; font-weight: 800; color: var(--muted); text-transform: uppercase; display: block; margin-bottom: 5px;">Tv√© hodnocen√≠</span>
                        <div id="resTopRating" style="font-size: 1.8rem; letter-spacing: 2px; line-height: 1;"></div>
                    </div>
                </div>
                
                <div id="resBody" style="margin-top:20px;"></div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; border-top: 2px solid var(--border); padding-top: 20px; margin-top: 30px;">
                    <button class="btn btn-outline" onclick="ulozitNovyAI()" id="btnSaveAI">üíæ Ulo≈æit do den√≠ku</button>
                    <div style="display:flex; gap:10px; align-items: center;" id="calendarSection">
                        <input type="date" id="dateIn" style="width:auto; margin:0; border:none; background:transparent; font-weight:700;">
                        <button class="btn btn-primary" onclick="doKalendare()">üìÖ Kalend√°≈ô</button>
                    </div>
                </div>

                <div id="commentsSection" style="display: none; margin-top: 40px; border-top: 2px solid var(--border); padding-top: 30px;">
                    <h3 style="font-size: 1.5rem; font-weight: 800; margin-bottom: 20px;">Koment√°≈ôe cestovatel≈Ø</h3>
                    <div id="commentsList" style="margin-bottom: 20px; max-height: 400px; overflow-y: auto; padding-right: 10px;"></div>
                    <div style="display: flex; gap: 15px; align-items: flex-start; background: var(--bg); padding: 20px; border-radius: 20px; border: 1px solid var(--border);">
                        <div class="comment-avatar" id="myMiniAvatar" style="width: 45px; height: 45px;">V</div>
                        <div style="flex: 1;">
                            <textarea id="newCommentText" rows="2" placeholder="P≈ôidej sv≈Øj post≈ôeh k tomuto v√Ωletu..." style="margin-bottom: 10px; padding: 12px 16px; border-radius: 12px; border: 1px solid var(--border); font-size: 0.95rem;"></textarea>
                            <button class="btn btn-primary" onclick="odeslatKomentar()" style="padding: 10px 20px; font-size: 0.9rem;">Odeslat koment√°≈ô</button>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <div id="globalMap" style="height: 400px; width: 100%; border-radius: var(--radius-card); border: 1px solid var(--border); box-shadow: var(--shadow); margin-bottom: 40px; z-index: 1;"></div>
                <h2 style="font-size: 2.2rem; margin-bottom: 30px;">Den√≠k expedic</h2>
                <div id="diary" class="bento-grid"></div>
            </div>
        </main>
    </div>

    <script>
        let curDraft = null, curOpenTripId = null, prihlaseno = false;
        let mainMap = null, markerCluster = null, mujProfil = null; 
        let pripraveneFotky = []; 

        async function init() {
            try {
                const res = await fetch('/api/auth-status');
                const data = await res.json();
                if(data.prihlaseno) {
                    prihlaseno = true;
                    mujProfil = data.profil;
                    const btnGoogle = document.getElementById('btnGoogle');
                    document.getElementById('btnProfil').style.display = 'inline-flex';
                    
                    document.getElementById('profPrezdivka').value = mujProfil.prezdivka || '';
                    document.getElementById('profVek').value = mujProfil.vek || '';
                    document.getElementById('profTelefon').value = mujProfil.telefon || '';
                    document.getElementById('profBio').value = mujProfil.bio || '';
                    
                    const avatarInit = (mujProfil.jmeno ? mujProfil.jmeno.charAt(0) : 'U').toUpperCase();
                    if(mujProfil.avatar) {
                        document.getElementById('profAvatar').style.backgroundImage = `url(${mujProfil.avatar})`;
                        document.getElementById('profAvatar').innerText = '';
                        document.getElementById('myMiniAvatar').style.backgroundImage = `url(${mujProfil.avatar})`;
                        document.getElementById('myMiniAvatar').innerText = '';
                    } else {
                        document.getElementById('profAvatar').innerText = avatarInit;
                        document.getElementById('myMiniAvatar').innerText = avatarInit;
                    }

                    if (data.profil.isAdmin) {
                        btnGoogle.innerHTML = "‚öôÔ∏è Admin <span class='admin-badge'>ROOT</span>";
                        localStorage.setItem('veronaPremium', 'true');
                    } else if (data.profil.isPremium) {
                        btnGoogle.innerText = "üëë Premium";
                        localStorage.setItem('veronaPremium', 'true');
                    } else {
                        btnGoogle.innerText = "‚úì Propojeno";
                    }
                    btnGoogle.onclick = (e) => e.preventDefault();
                }
            } catch(e) {}
            
            await nactiDnik();
            await nactiFeed();
        }

        // --- Z√ÅLO≈ΩKY ---
        function prepniHlavniTab(tab) {
            document.getElementById('t-komunita').classList.remove('active');
            document.getElementById('t-planovac').classList.remove('active');
            document.getElementById('viewKomunita').classList.add('hidden');
            document.getElementById('viewPlanovac').classList.add('hidden');

            document.getElementById(`t-${tab}`).classList.add('active');
            document.getElementById(tab === 'komunita' ? 'viewKomunita' : 'viewPlanovac').classList.remove('hidden');
            
            if (tab === 'planovac' && mainMap) { setTimeout(() => { mainMap.invalidateSize(); }, 200); }
        }

        function toggleAcc(id) { const c = document.getElementById(id); c.classList.toggle('open'); c.style.maxHeight = c.classList.contains('open') ? "450px" : "0px"; }
        function prepniRezim() { document.documentElement.setAttribute('data-theme', document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'); }

        // --- PROFIL ---
        function zmenitAvatar() {
            const input = document.createElement('input'); input.type = 'file'; input.accept = 'image/*';
            input.onchange = (e) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    mujProfil.avatar = reader.result;
                    document.getElementById('profAvatar').style.backgroundImage = `url(${reader.result})`;
                    document.getElementById('profAvatar').innerText = '';
                };
                reader.readAsDataURL(e.target.files[0]);
            };
            input.click();
        }
        async function ulozitProfil() {
            const data = { prezdivka: document.getElementById('profPrezdivka').value, vek: document.getElementById('profVek').value, telefon: document.getElementById('profTelefon').value, bio: document.getElementById('profBio').value, avatar: mujProfil.avatar || '' };
            await fetch('/api/ulozit-profil', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data) });
            document.getElementById('profileModal').style.display = 'none';
            alert("Profil aktualizov√°n!"); location.reload(); 
        }

        // --- MAPA ---
        function aktualizovatMapu(vylety) {
            if (!mainMap) {
                mainMap = L.map('globalMap').setView([49.8, 15.5], 5);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 18 }).addTo(mainMap);
                markerCluster = L.markerClusterGroup({ chunkedLoading: true, spiderfyOnMaxZoom: true });
                mainMap.addLayer(markerCluster);
            }
            markerCluster.clearLayers();
            const bodyNaMapu = [];
            const neonIcon = L.divIcon({ className: 'custom-map-marker', iconSize: [14, 14], iconAnchor: [7, 7] });

            vylety.forEach(x => {
                if (x.etapy && x.etapy.length > 0 && x.etapy[0].lat) {
                    const marker = L.marker([x.etapy[0].lat, x.etapy[0].lng], { icon: neonIcon });
                    marker.bindPopup(`<div style="text-align: center;"><h4 style="margin: 0 0 5px 0; color: #fff;">${x.lokace}</h4><button onclick="otevritGoogleMaps('${x.id}')" style="background: var(--primary); color: white; border: none; padding: 6px 12px; border-radius: 8px; cursor: pointer;">üìç Navigovat</button></div>`);
                    markerCluster.addLayer(marker);
                    bodyNaMapu.push([x.etapy[0].lat, x.etapy[0].lng]);
                }
            });
            if (bodyNaMapu.length > 0) mainMap.fitBounds(L.latLngBounds(bodyNaMapu).pad(0.1));
        }

        // --- DEN√çK KARET ---
        async function nactiDnik() {
            const v = await (await fetch('/api/ulozene-vylety')).json();
            aktualizovatMapu(v);
            const d = document.getElementById('diary');
            d.innerHTML = v.length ? "" : "<p style='color:var(--muted); grid-column: 1/-1; text-align:center;'>Den√≠k je pr√°zdn√Ω.</p>";
            
            const sel = document.getElementById('feedTripSelect');
            sel.innerHTML = '<option value="">Nep≈ôipojovat ≈æ√°dn√Ω v√Ωlet</option>';

            v.forEach(x => {
                sel.innerHTML += `<option value="${x.id}">${x.lokace}</option>`;
                const k = document.createElement('div'); k.className = `bento-card ${x.dokonceno ? 'done' : ''}`;
                
                let miniStars = `<span style="color:var(--primary); font-size:1.1rem;">${'‚òÖ'.repeat(x.hodnoceni || 0)}<span style="color:var(--border)">${'‚òÖ'.repeat(5-(x.hodnoceni||0))}</span></span>`;
                
                let fotosHTML = "";
                if(x.fotky && x.fotky.length > 0) {
                    fotosHTML = `<div class="photo-gallery">` + x.fotky.map(f => `<img src="${f}" class="photo-item" onclick="event.stopPropagation(); openGallery('${f}')">`).join('') + `</div>`;
                }

                let addPhotoBtn = (!x.fotky || x.fotky.length < 3) 
                    ? `<button class="btn btn-outline" style="padding:10px; font-size:0.85rem;" onclick="event.stopPropagation(); upload('${x.id}')">üì∏</button>` 
                    : ``;

                k.innerHTML = `
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:flex-start;">
                        <div>
                            <h4 style="margin:0 0 5px 0; font-size:1.5rem; font-weight:800; letter-spacing:-0.5px;">${x.lokace}</h4>
                            <span style="font-size:0.85rem; color:var(--muted); font-weight: 600;">${x.datumUlozeni}</span>
                        </div>
                        <button onclick="event.stopPropagation(); smazat('${x.id}')" style="background:var(--bg); border:1px solid var(--border); border-radius:50%; width:36px; height:36px; cursor:pointer; color:var(--muted);">‚úï</button>
                    </div>
                    
                    <div style="display:flex; justify-content:space-between; align-items: center; background: var(--bg); padding: 10px 15px; border-radius: 12px; border: 1px solid var(--border);">
                        <div><span style="font-size:0.7rem; text-transform:uppercase; font-weight:800; color:var(--muted); display:block;">Hodnocen√≠</span>${miniStars}</div>
                        <div style="text-align: right;"><span style="font-size:0.7rem; text-transform:uppercase; font-weight:800; color:var(--muted); display:block;">Koment√°≈ôe</span><span style="font-weight:900;">üí¨ ${x.komentare ? x.komentare.length : 0}</span></div>
                    </div>
                    
                    ${fotosHTML}

                    <div style="margin-top: auto; display:flex; gap:10px; margin-top:20px; align-items:center;">
                        ${addPhotoBtn}
                        <button class="btn btn-outline" style="padding:10px; font-size:0.85rem;" onclick="event.stopPropagation(); otevritGoogleMaps('${x.id}')">üìç</button>
                        <button class="btn btn-outline" style="padding:10px; font-size:0.85rem; border-color: var(--premium); color: var(--premium);" onclick="event.stopPropagation(); stahnoutGPX('${x.id}', '${x.lokace}')">üó∫Ô∏è GPX</button>
                        <button class="btn btn-primary" style="padding:10px; font-size:0.85rem; flex:1;" onclick="event.stopPropagation(); prepnoutStav('${x.id}', ${!x.dokonceno})">
                            ${x.dokonceno ? 'Zru≈°it' : '‚úì Splnƒõno'}
                        </button>
                    </div>
                `;
                k.onclick = (e) => {
                    if(e.target.tagName === 'BUTTON' || e.target.tagName === 'IMG') return;
                    otevritDetailVyletu(x);
                };
                d.appendChild(k);
            });
        }

        async function upload(id) {
            const v = await (await fetch('/api/ulozene-vylety')).json();
            const vylet = v.find(x => x.id === id);
            if(vylet.fotky && vylet.fotky.length >= 3) return alert("Lze nahr√°t max 3 fotky.");
            const input = document.createElement('input'); input.type = 'file'; input.accept = 'image/*';
            input.onchange = async (e) => {
                const reader = new FileReader();
                reader.onloadend = async () => {
                    if(!vylet.fotky) vylet.fotky = [];
                    vylet.fotky.push(reader.result);
                    await fetch('/api/upravit-vylet', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id, fotky: vylet.fotky}) });
                    nactiDnik();
                };
                reader.readAsDataURL(e.target.files[0]);
            };
            input.click();
        }

        async function prepnoutStav(id, stav) { await fetch('/api/upravit-vylet', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id, dokonceno: stav}) }); nactiDnik(); }
        async function smazat(id) { if(confirm("Smazat v√Ωlet?")) { await fetch(`/api/smazat-vylet/${id}`, { method: 'DELETE' }); nactiDnik(); document.getElementById('resCard').style.display='none'; } }

        // --- DETAIL, HODNOCEN√ç A MAZ√ÅN√ç/EDITACE KOMENT√Å≈ò≈Æ ---
        function otevritDetailVyletu(vylet) {
            curOpenTripId = vylet.id;
            document.getElementById('resTitle').innerText = vylet.lokace;
            document.getElementById('resDiffText').innerText = "Ulo≈æeno: " + vylet.datumUlozeni;
            document.getElementById('btnSaveAI').style.display = 'none'; 
            document.getElementById('resBody').innerHTML = vylet.popis;

            vykresliHvezdickyNaho≈ôe(vylet.id, vylet.hodnoceni || 0);
            vykresliKomentare(vylet.komentare || []);
            curDraft = vylet; 
            document.getElementById('resCard').style.display = 'block';
            window.scrollTo({top: document.getElementById('resCard').offsetTop - 100, behavior: 'smooth'});
        }

        function vykresliHvezdickyNaho≈ôe(idVyletu, aktualniHodnoceni) {
            let starsHTML = "";
            for(let i=1; i<=5; i++) {
                let barva = (i <= aktualniHodnoceni) ? '#F59E0B' : 'var(--border)';
                starsHTML += `<span class="star-hover" style="color:${barva}; transition:0.2s; display:inline-block;" onclick="ohodnotitVylet('${idVyletu}', ${i})">‚òÖ</span>`;
            }
            document.getElementById('resTopRating').innerHTML = starsHTML;
        }

        async function ohodnotitVylet(id, hodnoceni) {
            await fetch('/api/upravit-vylet', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id, hodnoceni}) });
            vykresliHvezdickyNaho≈ôe(id, hodnoceni); nactiDnik(); 
        }

        function vykresliKomentare(komentareArray) {
            const list = document.getElementById('commentsList');
            document.getElementById('commentsSection').style.display = 'block';
            
            if (!komentareArray || komentareArray.length === 0) {
                list.innerHTML = `<p style="color:var(--muted); font-style:italic; text-align:center;">Zat√≠m zde nejsou ≈æ√°dn√© koment√°≈ôe. Buƒète prvn√≠!</p>`;
                return;
            }

            let html = "";
            komentareArray.forEach(k => {
                let avatarStyle = k.avatar ? `background-image:url(${k.avatar}); color:transparent;` : ``;
                let iniciala = k.autor ? k.autor.charAt(0).toUpperCase() : 'U';
                
                // M≈Ø≈æe mazat/upravit, pokud je to on, nebo je admin
                let isOwner = prihlaseno && mujProfil && (k.autorId === mujProfil._id || mujProfil.isAdmin);
                let akceHtml = isOwner ? `
                    <div style="display:flex; gap:8px;">
                        <button class="action-btn" onclick="upravitKomentar('${k.id}', '${encodeURIComponent(k.text)}')">‚úèÔ∏è</button>
                        <button class="action-btn" onclick="smazatKomentar('${k.id}')">üóëÔ∏è</button>
                    </div>
                ` : ``;

                html += `
                    <div class="comment-box animate">
                        <div class="comment-avatar" style="${avatarStyle}">${iniciala}</div>
                        <div class="comment-content">
                            <div class="comment-author">
                                <div><span>${k.autor}</span> <span class="comment-date" style="margin-left:10px;">${k.datum}</span></div>
                                ${akceHtml}
                            </div>
                            <p class="comment-text">${k.text}</p>
                        </div>
                    </div>
                `;
            });
            list.innerHTML = html;
        }

        async function odeslatKomentar() {
            if(!prihlaseno) return alert("Pro p≈ôid√°n√≠ koment√°≈ôe se mus√≠te p≈ôihl√°sit.");
            if(!curOpenTripId) return;
            const text = document.getElementById('newCommentText').value.trim();
            if(!text) return;

            document.getElementById('newCommentText').value = "Odes√≠l√°m...";
            await fetch('/api/pridat-komentar', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ idVyletu: curOpenTripId, text: text }) });
            document.getElementById('newCommentText').value = "";
            
            const v = await (await fetch('/api/ulozene-vylety')).json();
            const aktualniVylet = v.find(x => x.id === curOpenTripId);
            vykresliKomentare(aktualniVylet.komentare); nactiDnik(); 
        }

        async function smazatKomentar(commentId) {
            if(!confirm("Opravdu chce≈° smazat tento koment√°≈ô?")) return;
            await fetch('/api/smazat-komentar', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ tripId: curOpenTripId, commentId }) });
            const v = await (await fetch('/api/ulozene-vylety')).json();
            vykresliKomentare(v.find(x => x.id === curOpenTripId).komentare); nactiDnik();
        }

        async function upravitKomentar(commentId, encodedText) {
            const staryText = decodeURIComponent(encodedText);
            const novyText = prompt("Upravit koment√°≈ô:", staryText);
            if (novyText !== null && novyText.trim() !== "" && novyText !== staryText) {
                await fetch('/api/upravit-komentar', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ tripId: curOpenTripId, commentId, text: novyText }) });
                const v = await (await fetch('/api/ulozene-vylety')).json();
                vykresliKomentare(v.find(x => x.id === curOpenTripId).komentare);
            }
        }

        // --- FEED / KOMUNITA MAZ√ÅN√ç/EDITACE ---
        function nactiFotkyDoFeedu(input) {
            const preview = document.getElementById('feedPhotoPreview');
            preview.innerHTML = ""; pripraveneFotky = [];
            Array.from(input.files).slice(0, 4).forEach(file => { 
                const reader = new FileReader();
                reader.onloadend = () => {
                    pripraveneFotky.push(reader.result);
                    preview.innerHTML += `<img src="${reader.result}" style="width: 80px; height: 80px; border-radius: 12px; object-fit: cover; border: 1px solid var(--border);">`;
                };
                reader.readAsDataURL(file);
            });
        }

        async function odeslatDoFeedu() {
            if(!prihlaseno) return alert("Mus√≠≈° b√Ωt p≈ôihl√°≈°en.");
            const text = document.getElementById('feedText').value.trim();
            if(!text && pripraveneFotky.length === 0) return alert("P≈ô√≠spƒõvek nem≈Ø≈æe b√Ωt pr√°zdn√Ω.");
            
            const tripSelect = document.getElementById('feedTripSelect');
            const pripojenyVyletId = tripSelect.value;
            const pripojenyVyletLokace = tripSelect.options[tripSelect.selectedIndex].text;

            document.getElementById('btnOdeslatFeed').innerText = "Odes√≠l√°m...";
            await fetch('/api/pridat-do-feedu', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ text, fotky: pripraveneFotky, pripojenyVyletId, pripojenyVyletLokace: pripojenyVyletId ? pripojenyVyletLokace : null }) });

            document.getElementById('feedText').value = ""; document.getElementById('feedPhotoPreview').innerHTML = ""; pripraveneFotky = [];
            document.getElementById('btnOdeslatFeed').innerText = "Odeslat do komunity"; nactiFeed();
        }

        async function nactiFeed() {
            const f = await (await fetch('/api/feed')).json();
            const container = document.getElementById('feedStream');
            
            if(f.length === 0) { container.innerHTML = `<p style="text-align: center; color: var(--muted); padding: 40px; border: 2px dashed var(--border); border-radius: 20px;">Komunita zat√≠m sp√≠. P≈ôidej prvn√≠ p≈ô√≠spƒõvek!</p>`; return; }

            let html = "";
            f.forEach(p => {
                let avatarStyle = p.autorAvatar ? `background-image:url(${p.autorAvatar}); color:transparent;` : ``;
                let iniciala = p.autorJmeno ? p.autorJmeno.charAt(0).toUpperCase() : 'U';
                
                let fotkyHtml = "";
                if(p.fotky && p.fotky.length > 0) { fotkyHtml = `<div class="photo-gallery" style="margin-bottom: 15px;">` + p.fotky.map(img => `<img src="${img}" class="photo-item" style="width: 120px; height: 120px;" onclick="openGallery('${img}')">`).join('') + `</div>`; }

                let tripHtml = "";
                if(p.pripojenyVyletId) {
                    tripHtml = `
                    <div class="feed-linked-trip">
                        <div><span style="font-size: 0.7rem; color: var(--primary); font-weight: 800; text-transform: uppercase;">Sd√≠len√Ω v√Ωlet</span><h4 style="margin: 0; font-size: 1.1rem;">${p.pripojenyVyletLokace}</h4></div>
                        <button class="btn btn-primary" style="padding: 8px 15px; font-size: 0.8rem;" onclick="otevritGoogleMaps('${p.pripojenyVyletId}')">üìç Otev≈ô√≠t mapu</button>
                    </div>`;
                }

                // Akƒçn√≠ tlaƒç√≠tka pro Feed
                let isOwner = prihlaseno && mujProfil && (p.autorId === mujProfil._id || mujProfil.isAdmin);
                let akceHtml = isOwner ? `
                    <div style="display:flex; gap:10px;">
                        <button class="action-btn" onclick="upravitFeed('${p._id}', '${encodeURIComponent(p.text)}')">‚úèÔ∏è</button>
                        <button class="action-btn" onclick="smazatFeed('${p._id}')">üóëÔ∏è</button>
                    </div>
                ` : ``;

                html += `
                    <div class="feed-post">
                        <div class="feed-header" style="justify-content: space-between;">
                            <div style="display:flex; align-items:center; gap:15px;">
                                <div class="comment-avatar" style="${avatarStyle}; width: 50px; height: 50px;">${iniciala}</div>
                                <div><h4 style="margin: 0 0 2px 0; font-size: 1.1rem;">${p.autorJmeno}</h4><span style="font-size: 0.8rem; color: var(--muted);">${p.datum}</span></div>
                            </div>
                            ${akceHtml}
                        </div>
                        <p class="feed-text">${p.text}</p>
                        ${fotkyHtml}
                        ${tripHtml}
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        async function smazatFeed(id) {
            if(!confirm("Opravdu smazat tento p≈ô√≠spƒõvek?")) return;
            await fetch(`/api/smazat-feed/${id}`, { method: 'DELETE' }); nactiFeed();
        }

        async function upravitFeed(id, encodedText) {
            const staryText = decodeURIComponent(encodedText);
            const novyText = prompt("Upravit p≈ô√≠spƒõvek:", staryText);
            if (novyText !== null && novyText.trim() !== "" && novyText !== staryText) {
                await fetch('/api/upravit-feed', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ postId: id, text: novyText }) });
                nactiFeed();
            }
        }

        // --- AI PLANNER A ZBYTEK ---
        async function generovat() {
            if (localStorage.getItem('veronaPremium') !== 'true') return document.getElementById('premiumModal').style.display = 'flex';
            if(!prihlaseno) return alert("Pros√≠m p≈ôihlaste se p≈ôes Google.");
            const misto = document.getElementById('mistoIn').value.trim(); if(!misto) return alert("Zadej lokalitu.");
            const vybraneFiltry = Array.from(document.querySelectorAll('.ai-filter:checked')).map(cb => cb.value);
            const btn = document.getElementById('genBtn'); btn.innerHTML = "Sestavuji..."; btn.disabled = true;

            try {
                const r = await fetch('/api/vylet', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ misto, specifikace: document.getElementById('specIn').value, vybraneFiltry }) });
                const res = await r.json();
                if(res.uspech) {
                    curDraft = res.data; curOpenTripId = null; 
                    document.getElementById('resTitle').innerText = curDraft.lokace;
                    document.getElementById('resDiffText').innerText = "AI Koncept - N√°roƒçnost " + (curDraft.obtiznost || 2);
                    document.getElementById('resTopRating').innerHTML = '<span style="color:var(--muted); font-size:1rem;">Ulo≈æ pro hodnocen√≠</span>';
                    document.getElementById('commentsSection').style.display = 'none';
                    document.getElementById('btnSaveAI').style.display = 'inline-flex';

                    let h = ""; 
                    curDraft.etapy.forEach((e) => { h += `<div class="step"><div class="step-time">${e.cas}</div><div class="step-content"><h4>${e.misto}</h4><p>${e.popis}</p></div></div>`; });
                    h += `<div class="animate-up" style="background:var(--primary-soft); padding:20px; border-radius:16px; color:var(--primary); font-weight:700; margin-top:25px;">üí° ${curDraft.doporuceni}</div>`;
                    document.getElementById('resBody').innerHTML = h; document.getElementById('resCard').style.display = 'block';
                    window.scrollTo({ top: document.getElementById('resCard').offsetTop - 100, behavior: 'smooth' });
                }
            } catch(e) {}
            btn.innerText = "‚ú® Sestavit pomoc√≠ AI"; btn.disabled = false;
        }

        async function ulozitNovyAI() {
            if(!curDraft) return;
            await fetch('/api/ulozit-vylet', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ lokace: curDraft.lokace, popis: document.getElementById('resBody').innerHTML, obtiznost: curDraft.obtiznost, typ: 'ai', etapy: curDraft.etapy }) });
            document.getElementById('resCard').style.display = 'none'; nactiDnik(); alert("Ulo≈æeno!");
        }

        function pridatEtapu() {
            const div = document.createElement('div'); div.className = "man-etapa"; div.style.cssText = "display:flex; gap:10px; margin-bottom:10px; align-items:center;";
            div.innerHTML = `<input type="time" class="e-cas" style="width:120px;" value="12:00"><input type="text" class="e-misto" placeholder="Bod cesty" style="flex:1;"><input type="text" class="e-popis" placeholder="Co tam uvid√≠me?" style="flex:2;"><button onclick="this.parentElement.remove()" style="background:none; border:none; cursor:pointer; color:var(--primary); font-size:1.2rem;">‚úï</button>`;
            document.getElementById('manEtapy').appendChild(div);
        }

        async function ulozitVlastni() {
            const lokace = document.getElementById('manLokace').value.trim();
            let html = `<div>`;
            document.querySelectorAll('.man-etapa').forEach(e => { html += `<div class="step"><div class="step-time">${e.querySelector('.e-cas').value}</div><div class="step-content"><h4>${e.querySelector('.e-misto').value}</h4><p>${e.querySelector('.e-popis').value}</p></div></div>`; });
            html += `</div>`;
            await fetch('/api/ulozit-vylet', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ lokace, popis: html, obtiznost: 2, typ: 'vlastni', etapy: [] }) });
            document.getElementById('manualModal').style.display = 'none'; nactiDnik();
        }

        function otevritGoogleMaps(id) { fetch('/api/ulozene-vylety').then(r => r.json()).then(v => { const vylet = v.find(x => x.id === id); if (!vylet || !vylet.etapy || vylet.etapy.length === 0 || !vylet.etapy[0].lat) return alert("Chyb√≠ GPS data."); const origin = `${vylet.etapy[0].lat},${vylet.etapy[0].lng}`; const destination = `${vylet.etapy[vylet.etapy.length-1].lat},${vylet.etapy[vylet.etapy.length-1].lng}`; let waypoints = ""; if (vylet.etapy.length > 2) { waypoints = "&waypoints=" + vylet.etapy.slice(1, -1).map(e => `${e.lat},${e.lng}`).join('|'); } window.open(`https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}${waypoints}&travelmode=walking`, '_blank'); }); }
        function stahnoutGPX(id, lokace) { fetch('/api/ulozene-vylety').then(r => r.json()).then(v => { const vylet = v.find(x => x.id === id); let gpx = `<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="VERONA" xmlns="http://www.topografix.com/GPX/1/1">\n  <rte><name>${lokace}</name>\n`; vylet.etapy.forEach(bod => { gpx += `    <rtept lat="${bod.lat}" lon="${bod.lng}"><name>${bod.misto}</name></rtept>\n`; }); gpx += `  </rte>\n</gpx>`; const blob = new Blob([gpx], { type: 'application/gpx+xml' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `${lokace.replace(/\s+/g, '_')}.gpx`; document.body.appendChild(a); a.click(); }); }
        function openGallery(src) { document.getElementById('lightboxImg').src = src; document.getElementById('lightbox').style.display = 'flex'; }
        
        async function doKalendare() {
            const datum = document.getElementById('dateIn').value; if(!datum) return alert("Zvol datum.");
            let mapaLink = "";
            if (curDraft && curDraft.etapy && curDraft.etapy.length > 0) {
                const o = `${curDraft.etapy[0].lat},${curDraft.etapy[0].lng}`; const d = `${curDraft.etapy[curDraft.etapy.length-1].lat},${curDraft.etapy[curDraft.etapy.length-1].lng}`; mapaLink = `https://www.google.com/maps/dir/?api=1&origin=${o}&destination=${d}&travelmode=walking`;
            }
            const r = await fetch('/api/kalendar', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ lokace: document.getElementById('resTitle').innerText, popis: "VERONA", datum, mapaLink }) });
            if((await r.json()).uspech) alert("P≈ôid√°no!");
        }

        window.onload = init;
    </script>
</body>
</html>